<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/infra-blog/assets/css/style.css">
<link rel="stylesheet" href="/infra-blog/assets/css/post-detail.css">
<style>
/* Post Detail Page Styling */
.post-container article {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  padding: 40px;
  margin: 30px auto;
  max-width: 800px;
}

@media screen and (max-width: 768px) {
  .post-container article {
    margin: 20px;
    padding: 25px;
    border-radius: 8px;
  }
}

.post-container article .post-header {
  border-bottom: 2px solid #f5f5f5;
  padding-bottom: 25px;
  margin-bottom: 30px;
}

.post-container article .post-header .post-title {
  font-size: 2.2em;
  font-weight: 700;
  color: #2c3e50;
  line-height: 1.3;
  margin-bottom: 15px;
}

@media screen and (max-width: 768px) {
  .post-container article .post-header .post-title {
    font-size: 1.8em;
  }
}

.post-container article .post-header .post-meta {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.post-container article .post-header .post-meta .post-date {
  display: flex;
  align-items: center;
  color: #666;
  font-size: 0.9em;
}

.post-container article .post-header .post-meta .post-date i {
  margin-right: 8px;
  color: #888;
}

.post-container article .post-header .post-meta .post-categories-wrapper {
  display: flex;
  align-items: center;
}

.post-container article .post-header .post-meta .post-categories-wrapper i {
  margin-right: 8px;
  color: #888;
}

.post-container article .post-header .post-meta .post-categories-wrapper .post-categories {
  display: flex;
  gap: 8px;
  list-style: none;
  margin: 0;
  padding: 0;
}

.post-container article .post-header .post-meta .post-categories-wrapper .post-categories li {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8em;
  font-weight: 500;
  text-transform: capitalize;
}

.post-container article .post-content {
  font-size: 1.1em;
  line-height: 1.8;
  color: #333;
}

.post-container article .post-content p {
  margin-bottom: 1.2em;
}

.post-container article .post-content h1,
.post-container article .post-content h2,
.post-container article .post-content h3,
.post-container article .post-content h4,
.post-container article .post-content h5,
.post-container article .post-content h6 {
  color: #2c3e50;
  margin: 1.5em 0 0.8em 0;
  font-weight: 600;
}

.post-container article .post-content h2 {
  font-size: 1.8em;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

.post-container article .post-content h3 {
  font-size: 1.5em;
  color: #34495e;
}

.post-container article .post-content code {
  background: #f8f9fa;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
  color: #e74c3c;
}

.post-container article .post-content pre {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 15px;
  overflow-x: auto;
  margin: 1.5em 0;
}

.post-container article .post-content pre code {
  background: none;
  color: #333;
  padding: 0;
}

.post-container article .post-content blockquote {
  border-left: 4px solid #3498db;
  background: #f8f9fa;
  padding: 15px 20px;
  margin: 1.5em 0;
  font-style: italic;
  color: #555;
}

.post-container article .post-content img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1.5em 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.post-container article .post-content ul,
.post-container article .post-content ol {
  padding-left: 1.5em;
  margin-bottom: 1.2em;
}

.post-container article .post-content ul li,
.post-container article .post-content ol li {
  margin-bottom: 0.5em;
}

.post-container article .post-content a {
  color: #3498db;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: all 0.3s ease;
}

.post-container article .post-content a:hover {
  border-bottom-color: #3498db;
}

.post-container article .post-footer {
  border-top: 2px solid #f5f5f5;
  padding-top: 25px;
  margin-top: 40px;
}

.post-container article .post-footer .post-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
}

@media screen and (max-width: 768px) {
  .post-container article .post-footer .post-navigation {
    flex-direction: column;
    gap: 15px;
  }
}

.post-container article .post-footer .post-navigation .nav-previous,
.post-container article .post-footer .post-navigation .nav-next {
  flex: 1;
}

.post-container article .post-footer .post-navigation .nav-previous a,
.post-container article .post-footer .post-navigation .nav-next a {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  background: #f8f9fa;
  border-radius: 8px;
  text-decoration: none;
  color: #333;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.post-container article .post-footer .post-navigation .nav-previous a:hover,
.post-container article .post-footer .post-navigation .nav-next a:hover {
  background: #e9ecef;
  border-color: #3498db;
  transform: translateY(-2px);
}

.post-container article .post-footer .post-navigation .nav-previous a i,
.post-container article .post-footer .post-navigation .nav-next a i {
  color: #3498db;
  margin: 0 8px;
}

.post-container article .post-footer .post-navigation .nav-previous a .nav-title,
.post-container article .post-footer .post-navigation .nav-next a .nav-title {
  font-weight: 500;
}

.post-container article .post-footer .post-navigation .nav-previous a {
  justify-content: flex-start;
}

.post-container article .post-footer .post-navigation .nav-next a {
  justify-content: flex-end;
  text-align: right;
}
</style>
<title>Nginx 운영 가이드 Part 2 - 성능 모니터링, 메트릭 수집, 상태 확인</title>

<script type="text/javascript" src="/infra-blog/assets/js/darkmode.js"></script>

</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/infra-blog/">
        
        <img src="/infra-blog/assets/portfolio.png" alt="Infrastructure Engineer" />
        
      </a>
      <h2 id="title">
        <a href="/infra-blog/">Infrastructure Engineer</a>
      </h2>
      </div><p class="tagline">DevOps & Cloud Infrastructure Specialist</p></div>
      
      <ul class="social about-footer condensed"><a href="https://github.com/leeyonghe" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/lee-yong-hee-18912454/" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><!----></ul><p class="about-footer condensed">&copy;
        2025</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </section>
    <section class="content">
      <style>
/* Post Detail Page Styling - Direct Inline */
.post-container article {
  background: #fff !important;
  border: none !important;
  border-top: none !important;
  border-right: none !important;
  border-bottom: none !important;
  border-left: none !important;
  border-width: 0 !important;
  border-style: none !important;
  outline: none !important;
  border-radius: 12px !important;
  box-shadow: none !important;
  padding: 40px !important;
  margin: 30px auto !important;
  max-width: 800px !important;
}

.post-container article .post-header .post-title {
  font-size: 2.2em !important;
  font-weight: 700 !important;
  color: #2c3e50 !important;
  line-height: 1.3 !important;
}

.post-container article .post-header {
  border-bottom: none !important;
  padding-bottom: 25px !important;
  margin-bottom: 30px !important;
}

.post-container article .post-content {
  font-size: 1.1em !important;
  line-height: 1.8 !important;
  color: #333 !important;
}

.post-container article .post-content h2 {
  font-size: 1.8em !important;
  border-bottom: none !important;
  padding-bottom: 10px !important;
  color: #2c3e50 !important;
}

.post-container article .post-header .post-meta .post-categories li {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  color: white !important;
  padding: 4px 12px !important;
  border-radius: 20px !important;
  font-size: 0.8em !important;
  list-style: none !important;
  display: inline-block !important;
  margin-right: 8px !important;
}

.post-container article .post-footer {
  border-top: none !important;
  padding-top: 25px !important;
  margin-top: 40px !important;
}

/* 모든 border와 box-shadow 강제 제거 */
.post-container article *,
.post-container article *::before,
.post-container article *::after {
  border: none !important;
  border-top: none !important;
  border-right: none !important;
  border-bottom: none !important;
  border-left: none !important;
  border-width: 0 !important;
  border-style: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* 코드 블록과 pre 태그도 border, box-shadow 제거 */
.post-container article pre,
.post-container article code,
.post-container article .highlight,
.post-container article .highlighter-rouge {
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}
</style><div class="post-container">
  <article>
    <header class="post-header">
    <h1 class="post-title">Nginx 운영 가이드 Part 2 - 성능 모니터링, 메트릭 수집, 상태 확인</h1>
    <div class="post-meta">
      <div class="post-date">
        <i class="icon-calendar"></i>
        <time datetime="2024-06-11T00:00:00+00:00">Jun 11, 2024</time>
      </div><div class="post-categories-wrapper">
        <i class="icon-tag"></i>
        <ul class="post-categories"><li>Infrastructure</li><li>Nginx</li><li>Monitoring</li></ul>
      </div></div>
  </header>

  <div class="post-content">
    <h1 id="nginx-운영-가이드-part-2---성능-모니터링-메트릭-수집-상태-확인">Nginx 운영 가이드 Part 2 - 성능 모니터링, 메트릭 수집, 상태 확인</h1>

<p>실무 운영 환경에서 Nginx의 성능을 효과적으로 모니터링하고 메트릭을 수집하는 방법을 다룹니다. Prometheus, Grafana와의 연동부터 실시간 알림 시스템까지 포괄적인 모니터링 전략을 학습합니다.</p>

<!--more-->

<h2 id="목차">목차</h2>
<ol>
  <li><a href="#성능-메트릭-기초">성능 메트릭 기초</a></li>
  <li><a href="#nginx-상태-모듈">Nginx 상태 모듈</a></li>
  <li><a href="#prometheus-연동">Prometheus 연동</a></li>
  <li><a href="#grafana-대시보드">Grafana 대시보드</a></li>
  <li><a href="#로그-기반-모니터링">로그 기반 모니터링</a></li>
  <li><a href="#알림-시스템">알림 시스템</a></li>
</ol>

<h2 id="성능-메트릭-기초">성능 메트릭 기초</h2>

<h3 id="핵심-성능-지표">핵심 성능 지표</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 기본 성능 메트릭 수집 스크립트</span>
<span class="c">#!/bin/bash</span>
<span class="c"># /usr/local/bin/nginx-metrics.sh</span>

<span class="nv">NGINX_STATUS_URL</span><span class="o">=</span><span class="s2">"http://localhost/nginx_status"</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/nginx/access.log"</span>

collect_basic_metrics<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"=== Nginx Performance Metrics </span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2"> ==="</span>
    
    <span class="c"># 연결 통계</span>
    <span class="k">if </span>curl <span class="nt">-s</span> <span class="nv">$NGINX_STATUS_URL</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
        </span><span class="nb">local </span><span class="nv">stats</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nv">$NGINX_STATUS_URL</span><span class="si">)</span>
        <span class="nb">echo</span> <span class="s2">"Connection Statistics:"</span>
        <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$stats</span><span class="s2">"</span> | <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do
            </span><span class="nb">echo</span> <span class="s2">"  </span><span class="nv">$line</span><span class="s2">"</span>
        <span class="k">done
    else
        </span><span class="nb">echo</span> <span class="s2">"Error: Cannot access nginx status page"</span>
    <span class="k">fi</span>
    
    <span class="c"># 프로세스 리소스 사용량</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Process Resource Usage:"</span>
    ps aux | <span class="nb">grep</span> <span class="s1">'[n]ginx'</span> | <span class="nb">awk</span> <span class="s1">'{
        cpu += $3
        mem += $4
        vsz += $5
        rss += $6
        processes++
    }
    END {
        printf "  Processes: %d\n", processes
        printf "  Total CPU: %.2f%%\n", cpu
        printf "  Total Memory: %.2f%%\n", mem
        printf "  Total VSZ: %.2f MB\n", vsz/1024
        printf "  Total RSS: %.2f MB\n", rss/1024
    }'</span>
    
    <span class="c"># 네트워크 연결 수</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Network Connections:"</span>
    <span class="nb">local </span><span class="nv">http_conn</span><span class="o">=</span><span class="si">$(</span>ss <span class="nt">-tuln</span> | <span class="nb">grep</span> <span class="nt">-c</span> <span class="s2">":80 "</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">https_conn</span><span class="o">=</span><span class="si">$(</span>ss <span class="nt">-tuln</span> | <span class="nb">grep</span> <span class="nt">-c</span> <span class="s2">":443 "</span><span class="si">)</span>
    <span class="nb">echo</span> <span class="s2">"  HTTP connections: </span><span class="nv">$http_conn</span><span class="s2">"</span>
    <span class="nb">echo</span> <span class="s2">"  HTTPS connections: </span><span class="nv">$https_conn</span><span class="s2">"</span>
    
    <span class="c"># 최근 요청 통계 (지난 1분)</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Recent Request Statistics:"</span>
    <span class="nb">local </span><span class="nv">one_min_ago</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-d</span> <span class="s1">'1 minute ago'</span> <span class="s1">'+%d/%b/%Y:%H:%M'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">recent_requests</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="s2">"</span><span class="nv">$one_min_ago</span><span class="s2">"</span> <span class="nv">$LOG_FILE</span> 2&gt;/dev/null | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="nb">echo</span> <span class="s2">"  Requests in last minute: </span><span class="nv">$recent_requests</span><span class="s2">"</span>
    <span class="nb">echo</span> <span class="s2">"  Requests per second: </span><span class="k">$((</span>recent_requests <span class="o">/</span> <span class="m">60</span><span class="k">))</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># 응답 시간 분석</span>
analyze_response_times<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">=== Response Time Analysis ==="</span>
    
    <span class="c"># 최근 1000개 요청의 응답 시간 분석</span>
    <span class="nb">tail</span> <span class="nt">-1000</span> <span class="nv">$LOG_FILE</span> | <span class="nb">awk</span> <span class="s1">'{
        # 로그 형식에 따라 응답 시간 필드 조정 필요
        if (NF &gt;= 12 &amp;&amp; $12 ~ /^[0-9]/) {
            response_time = $12
            total += response_time
            count++
            
            if (response_time &lt; 0.1) fast++
            else if (response_time &lt; 0.5) medium++
            else if (response_time &lt; 1.0) slow++
            else very_slow++
            
            if (response_time &gt; max_time) max_time = response_time
            if (min_time == 0 || response_time &lt; min_time) min_time = response_time
        }
    }
    END {
        if (count &gt; 0) {
            printf "  Total requests analyzed: %d\n", count
            printf "  Average response time: %.3fs\n", total/count
            printf "  Min response time: %.3fs\n", min_time
            printf "  Max response time: %.3fs\n", max_time
            printf "  Fast (&lt; 0.1s): %d (%.1f%%)\n", fast, fast/count*100
            printf "  Medium (0.1-0.5s): %d (%.1f%%)\n", medium, medium/count*100
            printf "  Slow (0.5-1.0s): %d (%.1f%%)\n", slow, slow/count*100
            printf "  Very slow (&gt; 1.0s): %d (%.1f%%)\n", very_slow, very_slow/count*100
        }
    }'</span>
<span class="o">}</span>

<span class="c"># 에러율 분석</span>
analyze_error_rates<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">=== Error Rate Analysis ==="</span>
    
    <span class="nb">tail</span> <span class="nt">-10000</span> <span class="nv">$LOG_FILE</span> | <span class="nb">awk</span> <span class="s1">'{
        status = $9
        total++
        
        if (status ~ /^2/) success++
        else if (status ~ /^3/) redirect++
        else if (status ~ /^4/) client_error++
        else if (status ~ /^5/) server_error++
    }
    END {
        if (total &gt; 0) {
            printf "  Total requests: %d\n", total
            printf "  Success (2xx): %d (%.2f%%)\n", success, success/total*100
            printf "  Redirects (3xx): %d (%.2f%%)\n", redirect, redirect/total*100
            printf "  Client errors (4xx): %d (%.2f%%)\n", client_error, client_error/total*100
            printf "  Server errors (5xx): %d (%.2f%%)\n", server_error, server_error/total*100
            printf "  Overall error rate: %.2f%%\n", (client_error+server_error)/total*100
        }
    }'</span>
<span class="o">}</span>

collect_basic_metrics
analyze_response_times
analyze_error_rates
</code></pre></div></div>

<h2 id="nginx-상태-모듈">Nginx 상태 모듈</h2>

<h3 id="stub_status-모듈-설정">stub_status 모듈 설정</h3>
<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># nginx.conf에 상태 페이지 추가</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">localhost</span><span class="p">;</span>
    
    <span class="c1"># 상태 페이지</span>
    <span class="kn">location</span> <span class="n">/nginx_status</span> <span class="p">{</span>
        <span class="kn">stub_status</span> <span class="no">on</span><span class="p">;</span>
        
        <span class="c1"># 접근 제한</span>
        <span class="kn">allow</span> <span class="mf">127.0</span><span class="s">.0.1</span><span class="p">;</span>
        <span class="kn">allow</span> <span class="mf">192.168</span><span class="s">.0.0/16</span><span class="p">;</span>
        <span class="kn">allow</span> <span class="mf">10.0</span><span class="s">.0.0/8</span><span class="p">;</span>
        <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
        
        <span class="c1"># 로그 비활성화</span>
        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1"># 확장 상태 정보 (nginx-plus)</span>
    <span class="kn">location</span> <span class="n">/status</span> <span class="p">{</span>
        <span class="kn">status</span><span class="p">;</span>
        <span class="kn">status_format</span> <span class="s">json</span><span class="p">;</span>
        
        <span class="kn">allow</span> <span class="mf">127.0</span><span class="s">.0.1</span><span class="p">;</span>
        <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="상태-정보-파싱-스크립트">상태 정보 파싱 스크립트</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># /usr/local/bin/nginx-status-parser.sh</span>

<span class="nv">NGINX_STATUS_URL</span><span class="o">=</span><span class="s2">"http://localhost/nginx_status"</span>
<span class="nv">OUTPUT_FILE</span><span class="o">=</span><span class="s2">"/var/log/nginx/status_metrics.log"</span>

parse_stub_status<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">status_output</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nv">$NGINX_STATUS_URL</span> 2&gt;/dev/null<span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Error: Could not fetch nginx status"</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
    
    <span class="c"># stub_status 출력 파싱</span>
    <span class="c"># Active connections: 2</span>
    <span class="c"># server accepts handled requests</span>
    <span class="c">#  16630948 16630948 31070465</span>
    <span class="c"># Reading: 0 Writing: 2 Waiting: 0</span>
    
    <span class="nb">local </span><span class="nv">timestamp</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="s1">'+%Y-%m-%d %H:%M:%S'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">active_conn</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Active connections"</span> | <span class="nb">awk</span> <span class="s1">'{print $3}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">accepts</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'3p'</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">handled</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'3p'</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">requests</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'3p'</span> | <span class="nb">awk</span> <span class="s1">'{print $3}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">reading</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Reading"</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">writing</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Writing"</span> | <span class="nb">awk</span> <span class="s1">'{print $4}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">waiting</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Waiting"</span> | <span class="nb">awk</span> <span class="s1">'{print $6}'</span><span class="si">)</span>
    
    <span class="c"># Prometheus 형식으로 출력</span>
    <span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
# HELP nginx_connections_active Active connections
# TYPE nginx_connections_active gauge
nginx_connections_active </span><span class="nv">$active_conn</span><span class="sh">

# HELP nginx_connections_reading Reading connections
# TYPE nginx_connections_reading gauge
nginx_connections_reading </span><span class="nv">$reading</span><span class="sh">

# HELP nginx_connections_writing Writing connections
# TYPE nginx_connections_writing gauge
nginx_connections_writing </span><span class="nv">$writing</span><span class="sh">

# HELP nginx_connections_waiting Waiting connections
# TYPE nginx_connections_waiting gauge
nginx_connections_waiting </span><span class="nv">$waiting</span><span class="sh">

# HELP nginx_accepts_total Total accepted connections
# TYPE nginx_accepts_total counter
nginx_accepts_total </span><span class="nv">$accepts</span><span class="sh">

# HELP nginx_handled_total Total handled connections
# TYPE nginx_handled_total counter
nginx_handled_total </span><span class="nv">$handled</span><span class="sh">

# HELP nginx_requests_total Total requests
# TYPE nginx_requests_total counter
nginx_requests_total </span><span class="nv">$requests</span><span class="sh">
</span><span class="no">EOF
    
</span>    <span class="c"># 로그 파일에도 기록</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$timestamp</span><span class="s2">,</span><span class="nv">$active_conn</span><span class="s2">,</span><span class="nv">$reading</span><span class="s2">,</span><span class="nv">$writing</span><span class="s2">,</span><span class="nv">$waiting</span><span class="s2">,</span><span class="nv">$accepts</span><span class="s2">,</span><span class="nv">$handled</span><span class="s2">,</span><span class="nv">$requests</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUT_FILE</span>
<span class="o">}</span>

<span class="c"># JSON 형식으로 출력 (API용)</span>
output_json<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">status_output</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nv">$NGINX_STATUS_URL</span> 2&gt;/dev/null<span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s1">'{"error": "Could not fetch nginx status"}'</span>
        <span class="k">return </span>1
    <span class="k">fi
    
    </span><span class="nb">local </span><span class="nv">active_conn</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Active connections"</span> | <span class="nb">awk</span> <span class="s1">'{print $3}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">accepts</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'3p'</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">handled</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'3p'</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">requests</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'3p'</span> | <span class="nb">awk</span> <span class="s1">'{print $3}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">reading</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Reading"</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">writing</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Writing"</span> | <span class="nb">awk</span> <span class="s1">'{print $4}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">waiting</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$status_output</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"Waiting"</span> | <span class="nb">awk</span> <span class="s1">'{print $6}'</span><span class="si">)</span>
    
    <span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
{
  "timestamp": "</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-u</span> +%Y-%m-%dT%H:%M:%SZ<span class="si">)</span><span class="sh">",
  "connections": {
    "active": </span><span class="nv">$active_conn</span><span class="sh">,
    "reading": </span><span class="nv">$reading</span><span class="sh">,
    "writing": </span><span class="nv">$writing</span><span class="sh">,
    "waiting": </span><span class="nv">$waiting</span><span class="sh">
  },
  "requests": {
    "accepts": </span><span class="nv">$accepts</span><span class="sh">,
    "handled": </span><span class="nv">$handled</span><span class="sh">,
    "total": </span><span class="nv">$requests</span><span class="sh">
  }
}
</span><span class="no">EOF
</span><span class="o">}</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in</span>
    <span class="s2">"prometheus"</span><span class="p">)</span>
        parse_stub_status
        <span class="p">;;</span>
    <span class="s2">"json"</span><span class="p">)</span>
        output_json
        <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
        parse_stub_status
        <span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div></div>

<h2 id="prometheus-연동">Prometheus 연동</h2>

<h3 id="nginx-prometheus-exporter-설정">nginx-prometheus-exporter 설정</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># docker-compose.yml for nginx-prometheus-exporter</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">nginx-exporter</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx/nginx-prometheus-exporter:0.10.0</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9113:9113"</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">-nginx.scrape-uri=http://nginx:80/nginx_status'</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nginx</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">monitoring</span>

  <span class="na">prometheus</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">prom/prometheus:latest</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9090:9090"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./prometheus.yml:/etc/prometheus/prometheus.yml</span>
      <span class="pi">-</span> <span class="s">prometheus_data:/prometheus</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">--config.file=/etc/prometheus/prometheus.yml'</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">--storage.tsdb.path=/prometheus'</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">--web.console.libraries=/etc/prometheus/console_libraries'</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">--web.console.templates=/etc/prometheus/consoles'</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">monitoring</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">monitoring</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">prometheus_data</span><span class="pi">:</span>
</code></pre></div></div>

<h3 id="prometheus-설정">Prometheus 설정</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># prometheus.yml</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">15s</span>
  <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">15s</span>

<span class="na">rule_files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">nginx_rules.yml"</span>

<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">nginx'</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">nginx-exporter:9113'</span><span class="pi">]</span>
    <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">metrics_path</span><span class="pi">:</span> <span class="s">/metrics</span>

  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">node'</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">node-exporter:9100'</span><span class="pi">]</span>

<span class="na">alerting</span><span class="pi">:</span>
  <span class="na">alertmanagers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">static_configs</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">alertmanager:9093</span>
</code></pre></div></div>

<h3 id="nginx-관련-알림-규칙">Nginx 관련 알림 규칙</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># nginx_rules.yml</span>
<span class="na">groups</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">rules</span><span class="pi">:</span>
  
  <span class="c1"># 높은 에러율 알림</span>
  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">NginxHighErrorRate</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">(</span>
        <span class="s">sum(rate(nginx_http_requests_total{status=~"5.."}[5m]))</span>
        <span class="s">/</span>
        <span class="s">sum(rate(nginx_http_requests_total[5m]))</span>
      <span class="s">) * 100 &gt; 5</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">5m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">high</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">rate"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">%</span><span class="nv"> </span><span class="s">over</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes"</span>

  <span class="c1"># 높은 응답 시간 알림</span>
  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">NginxHighResponseTime</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">nginx_http_request_duration_seconds{quantile="0.95"} &gt; </span><span class="m">1</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">5m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">high</span><span class="nv"> </span><span class="s">response</span><span class="nv"> </span><span class="s">time"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">95th</span><span class="nv"> </span><span class="s">percentile</span><span class="nv"> </span><span class="s">response</span><span class="nv"> </span><span class="s">time</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">s"</span>

  <span class="c1"># 낮은 성공률 알림</span>
  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">NginxLowSuccessRate</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">(</span>
        <span class="s">sum(rate(nginx_http_requests_total{status=~"2.."}[5m]))</span>
        <span class="s">/</span>
        <span class="s">sum(rate(nginx_http_requests_total[5m]))</span>
      <span class="s">) * 100 &lt; 95</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">10m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">low</span><span class="nv"> </span><span class="s">success</span><span class="nv"> </span><span class="s">rate"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Success</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">%</span><span class="nv"> </span><span class="s">over</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">10</span><span class="nv"> </span><span class="s">minutes"</span>

  <span class="c1"># 연결 수 급증 알림</span>
  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">NginxHighConnections</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">nginx_connections_active &gt; </span><span class="m">1000</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">2m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">high</span><span class="nv"> </span><span class="s">active</span><span class="nv"> </span><span class="s">connections"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Active</span><span class="nv"> </span><span class="s">connections:</span><span class="nv"> </span><span class="s">"</span>

  <span class="c1"># Nginx 서비스 다운 알림</span>
  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">NginxDown</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">up{job="nginx"} == </span><span class="m">0</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">1m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">service</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">down"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Nginx</span><span class="nv"> </span><span class="s">service</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">minute"</span>
</code></pre></div></div>

<h2 id="grafana-대시보드">Grafana 대시보드</h2>

<h3 id="nginx-대시보드-json">Nginx 대시보드 JSON</h3>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"dashboard"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Nginx Performance Dashboard"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"style"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dark"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"timezone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"panels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Requests per Second"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"graph"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rate(nginx_requests_total[5m])"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RPS"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"yAxes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Requests/sec"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Active Connections"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"singlestat"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx_connections_active"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Active"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Error Rate"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"graph"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sum(rate(nginx_http_requests_total{status=~</span><span class="se">\"</span><span class="s2">4..</span><span class="se">\"</span><span class="s2">}[5m])) by (status)"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4xx Errors"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sum(rate(nginx_http_requests_total{status=~</span><span class="se">\"</span><span class="s2">5..</span><span class="se">\"</span><span class="s2">}[5m])) by (status)"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5xx Errors"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"from"</span><span class="p">:</span><span class="w"> </span><span class="s2">"now-1h"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"to"</span><span class="p">:</span><span class="w"> </span><span class="s2">"now"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"refresh"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10s"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="대시보드-프로비저닝">대시보드 프로비저닝</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># grafana/provisioning/dashboards/nginx.yml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="m">1</span>

<span class="na">providers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">nginx'</span>
    <span class="na">orgId</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">folder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Nginx'</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">file</span>
    <span class="na">disableDeletion</span><span class="pi">:</span> <span class="kc">false</span>
    <span class="na">updateIntervalSeconds</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">allowUiUpdates</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/var/lib/grafana/dashboards/nginx</span>
</code></pre></div></div>

<h2 id="로그-기반-모니터링">로그 기반 모니터링</h2>

<h3 id="실시간-로그-분석기">실시간 로그 분석기</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># /usr/local/bin/nginx-log-monitor.sh</span>

<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/nginx/access.log"</span>
<span class="nv">METRICS_FILE</span><span class="o">=</span><span class="s2">"/var/log/nginx/realtime_metrics.txt"</span>
<span class="nv">ALERT_THRESHOLD_ERROR_RATE</span><span class="o">=</span>5  <span class="c"># 5% 이상 에러율</span>
<span class="nv">ALERT_THRESHOLD_RESPONSE_TIME</span><span class="o">=</span>2  <span class="c"># 2초 이상 응답시간</span>

<span class="c"># 실시간 메트릭 계산</span>
calculate_realtime_metrics<span class="o">()</span> <span class="o">{</span>
    <span class="c"># 최근 1분간의 로그 분석</span>
    <span class="nb">local </span><span class="nv">one_min_ago</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-d</span> <span class="s1">'1 minute ago'</span> <span class="s1">'+%d/%b/%Y:%H:%M'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">current_min</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="s1">'+%d/%b/%Y:%H:%M'</span><span class="si">)</span>
    
    <span class="nb">tail</span> <span class="nt">-10000</span> <span class="nv">$LOG_FILE</span> | <span class="nb">awk</span> <span class="nt">-v</span> <span class="nv">start</span><span class="o">=</span><span class="s2">"</span><span class="nv">$one_min_ago</span><span class="s2">"</span> <span class="nt">-v</span> <span class="nv">end</span><span class="o">=</span><span class="s2">"</span><span class="nv">$current_min</span><span class="s2">"</span> <span class="s1">'
    BEGIN {
        total = 0
        success = 0
        client_error = 0
        server_error = 0
        total_response_time = 0
        max_response_time = 0
    }
    {
        # 시간 필터링 (로그 형식에 따라 조정 필요)
        log_time = $4
        gsub(/\[/, "", log_time)
        
        if (log_time &gt;= start &amp;&amp; log_time &lt;= end) {
            total++
            status = $9
            
            # 응답 시간 (로그 형식에 따라 필드 번호 조정)
            if (NF &gt;= 12 &amp;&amp; $12 ~ /^[0-9]/) {
                response_time = $12
                total_response_time += response_time
                if (response_time &gt; max_response_time) {
                    max_response_time = response_time
                }
            }
            
            # 상태 코드 분류
            if (status ~ /^2/) success++
            else if (status ~ /^4/) client_error++
            else if (status ~ /^5/) server_error++
        }
    }
    END {
        if (total &gt; 0) {
            error_rate = (client_error + server_error) / total * 100
            avg_response_time = total_response_time / total
            
            printf "timestamp=%s\n", strftime("%Y-%m-%d %H:%M:%S")
            printf "total_requests=%d\n", total
            printf "requests_per_second=%.2f\n", total/60
            printf "success_rate=%.2f\n", success/total*100
            printf "error_rate=%.2f\n", error_rate
            printf "avg_response_time=%.3f\n", avg_response_time
            printf "max_response_time=%.3f\n", max_response_time
        }
    }'</span> <span class="o">&gt;</span> <span class="nv">$METRICS_FILE</span>
<span class="o">}</span>

<span class="c"># 알림 확인 및 발송</span>
check_alerts<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$METRICS_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        return
    fi
    
    </span><span class="nb">local </span><span class="nv">error_rate</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="s2">"error_rate="</span> <span class="nv">$METRICS_FILE</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="s1">'='</span> <span class="nt">-f2</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">max_response_time</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="s2">"max_response_time="</span> <span class="nv">$METRICS_FILE</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="s1">'='</span> <span class="nt">-f2</span><span class="si">)</span>
    
    <span class="c"># 에러율 알림</span>
    <span class="k">if</span> <span class="o">((</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$error_rate</span><span class="s2"> &gt; </span><span class="nv">$ALERT_THRESHOLD_ERROR_RATE</span><span class="s2">"</span> | bc <span class="nt">-l</span><span class="si">)</span> <span class="o">))</span><span class="p">;</span> <span class="k">then
        </span>send_alert <span class="s2">"HIGH_ERROR_RATE"</span> <span class="s2">"Error rate: </span><span class="k">${</span><span class="nv">error_rate</span><span class="k">}</span><span class="s2">% (threshold: </span><span class="k">${</span><span class="nv">ALERT_THRESHOLD_ERROR_RATE</span><span class="k">}</span><span class="s2">%)"</span>
    <span class="k">fi</span>
    
    <span class="c"># 응답시간 알림</span>
    <span class="k">if</span> <span class="o">((</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$max_response_time</span><span class="s2"> &gt; </span><span class="nv">$ALERT_THRESHOLD_RESPONSE_TIME</span><span class="s2">"</span> | bc <span class="nt">-l</span><span class="si">)</span> <span class="o">))</span><span class="p">;</span> <span class="k">then
        </span>send_alert <span class="s2">"HIGH_RESPONSE_TIME"</span> <span class="s2">"Max response time: </span><span class="k">${</span><span class="nv">max_response_time</span><span class="k">}</span><span class="s2">s (threshold: </span><span class="k">${</span><span class="nv">ALERT_THRESHOLD_RESPONSE_TIME</span><span class="k">}</span><span class="s2">s)"</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 알림 발송 함수</span>
send_alert<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">alert_type</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">message</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">timestamp</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="s1">'+%Y-%m-%d %H:%M:%S'</span><span class="si">)</span>
    
    <span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$timestamp</span><span class="s2">] ALERT: </span><span class="nv">$alert_type</span><span class="s2"> - </span><span class="nv">$message</span><span class="s2">"</span>
    
    <span class="c"># Slack 알림 (webhook URL 필요)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLACK_WEBHOOK_URL</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s1">'Content-type: application/json'</span> <span class="se">\</span>
            <span class="nt">--data</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">text</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Nginx Alert: </span><span class="nv">$alert_type</span><span class="se">\\</span><span class="s2">n</span><span class="nv">$message</span><span class="se">\"</span><span class="s2">}"</span> <span class="se">\</span>
            <span class="nv">$SLACK_WEBHOOK_URL</span>
    <span class="k">fi</span>
    
    <span class="c"># 이메일 알림</span>
    <span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> mail <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$message</span><span class="s2">"</span> | mail <span class="nt">-s</span> <span class="s2">"Nginx Alert: </span><span class="nv">$alert_type</span><span class="s2">"</span> admin@example.com
    <span class="k">fi</span>
    
    <span class="c"># 로그 기록</span>
    <span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$timestamp</span><span class="s2">] </span><span class="nv">$alert_type</span><span class="s2">: </span><span class="nv">$message</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /var/log/nginx/alerts.log
<span class="o">}</span>

<span class="c"># 메인 실행</span>
calculate_realtime_metrics
check_alerts

<span class="c"># Prometheus 형식으로 메트릭 노출</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"prometheus"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$METRICS_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        while </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">'='</span> <span class="nb">read</span> <span class="nt">-r</span> key value<span class="p">;</span> <span class="k">do
            case</span> <span class="nv">$key</span> <span class="k">in
                </span>total_requests<span class="p">)</span>
                    <span class="nb">echo</span> <span class="s2">"# HELP nginx_realtime_requests_total Total requests in last minute"</span>
                    <span class="nb">echo</span> <span class="s2">"# TYPE nginx_realtime_requests_total gauge"</span>
                    <span class="nb">echo</span> <span class="s2">"nginx_realtime_requests_total </span><span class="nv">$value</span><span class="s2">"</span>
                    <span class="p">;;</span>
                requests_per_second<span class="p">)</span>
                    <span class="nb">echo</span> <span class="s2">"# HELP nginx_realtime_rps Requests per second"</span>
                    <span class="nb">echo</span> <span class="s2">"# TYPE nginx_realtime_rps gauge"</span>
                    <span class="nb">echo</span> <span class="s2">"nginx_realtime_rps </span><span class="nv">$value</span><span class="s2">"</span>
                    <span class="p">;;</span>
                error_rate<span class="p">)</span>
                    <span class="nb">echo</span> <span class="s2">"# HELP nginx_realtime_error_rate Error rate percentage"</span>
                    <span class="nb">echo</span> <span class="s2">"# TYPE nginx_realtime_error_rate gauge"</span>
                    <span class="nb">echo</span> <span class="s2">"nginx_realtime_error_rate </span><span class="nv">$value</span><span class="s2">"</span>
                    <span class="p">;;</span>
                avg_response_time<span class="p">)</span>
                    <span class="nb">echo</span> <span class="s2">"# HELP nginx_realtime_avg_response_time Average response time"</span>
                    <span class="nb">echo</span> <span class="s2">"# TYPE nginx_realtime_avg_response_time gauge"</span>
                    <span class="nb">echo</span> <span class="s2">"nginx_realtime_avg_response_time </span><span class="nv">$value</span><span class="s2">"</span>
                    <span class="p">;;</span>
            <span class="k">esac</span>
        <span class="k">done</span> &lt; <span class="nv">$METRICS_FILE</span>
    <span class="k">fi
fi</span>
</code></pre></div></div>

<h2 id="알림-시스템">알림 시스템</h2>

<h3 id="alertmanager-설정">Alertmanager 설정</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># alertmanager.yml</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">smtp_smarthost</span><span class="pi">:</span> <span class="s1">'</span><span class="s">localhost:587'</span>
  <span class="na">smtp_from</span><span class="pi">:</span> <span class="s1">'</span><span class="s">alerts@example.com'</span>
  <span class="na">slack_api_url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'</span>

<span class="na">route</span><span class="pi">:</span>
  <span class="na">group_by</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">alertname'</span><span class="pi">]</span>
  <span class="na">group_wait</span><span class="pi">:</span> <span class="s">10s</span>
  <span class="na">group_interval</span><span class="pi">:</span> <span class="s">10s</span>
  <span class="na">repeat_interval</span><span class="pi">:</span> <span class="s">1h</span>
  <span class="na">receiver</span><span class="pi">:</span> <span class="s1">'</span><span class="s">web.hook'</span>
  <span class="na">routes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
    <span class="na">receiver</span><span class="pi">:</span> <span class="s1">'</span><span class="s">critical-alerts'</span>
  <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
    <span class="na">receiver</span><span class="pi">:</span> <span class="s1">'</span><span class="s">warning-alerts'</span>

<span class="na">receivers</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">web.hook'</span>
  <span class="na">webhook_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">http://127.0.0.1:5001/'</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">critical-alerts'</span>
  <span class="na">email_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">admin@example.com'</span>
    <span class="na">subject</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Critical</span><span class="nv"> </span><span class="s">Alert:</span><span class="nv"> </span><span class="s">'</span>
    <span class="na">body</span><span class="pi">:</span> <span class="pi">|</span>
      
      <span class="s">Alert: </span>
      <span class="s">Description: </span>
      
  <span class="na">slack_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">channel</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#alerts'</span>
    <span class="na">color</span><span class="pi">:</span> <span class="s">danger</span>
    <span class="na">title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Critical</span><span class="nv"> </span><span class="s">Alert'</span>
    <span class="na">text</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">warning-alerts'</span>
  <span class="na">slack_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">channel</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#monitoring'</span>
    <span class="na">color</span><span class="pi">:</span> <span class="s">warning</span>
    <span class="na">title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Warning</span><span class="nv"> </span><span class="s">Alert'</span>
    <span class="na">text</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>

<span class="na">inhibit_rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">source_match</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s1">'</span><span class="s">critical'</span>
    <span class="na">target_match</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s1">'</span><span class="s">warning'</span>
    <span class="na">equal</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">alertname'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">dev'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">instance'</span><span class="pi">]</span>
</code></pre></div></div>

<h3 id="커스텀-웹훅-알림-서버">커스텀 웹훅 알림 서버</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
# /usr/local/bin/nginx-alert-webhook.py
</span>
<span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">smtplib</span>
<span class="kn">from</span> <span class="n">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="n">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">logging</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># 설정
</span><span class="n">SMTP_SERVER</span> <span class="o">=</span> <span class="sh">'</span><span class="s">smtp.example.com</span><span class="sh">'</span>
<span class="n">SMTP_PORT</span> <span class="o">=</span> <span class="mi">587</span>
<span class="n">EMAIL_USERNAME</span> <span class="o">=</span> <span class="sh">'</span><span class="s">alerts@example.com</span><span class="sh">'</span>
<span class="n">EMAIL_PASSWORD</span> <span class="o">=</span> <span class="sh">'</span><span class="s">your_password</span><span class="sh">'</span>
<span class="n">SLACK_WEBHOOK_URL</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK</span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">to_email</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">이메일 알림 발송</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nc">MIMEMultipart</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">[</span><span class="sh">'</span><span class="s">From</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIL_USERNAME</span>
        <span class="n">msg</span><span class="p">[</span><span class="sh">'</span><span class="s">To</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_email</span>
        <span class="n">msg</span><span class="p">[</span><span class="sh">'</span><span class="s">Subject</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
        
        <span class="n">msg</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nc">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="sh">'</span><span class="s">html</span><span class="sh">'</span><span class="p">))</span>
        
        <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="p">.</span><span class="nc">SMTP</span><span class="p">(</span><span class="n">SMTP_SERVER</span><span class="p">,</span> <span class="n">SMTP_PORT</span><span class="p">)</span>
        <span class="n">server</span><span class="p">.</span><span class="nf">starttls</span><span class="p">()</span>
        <span class="n">server</span><span class="p">.</span><span class="nf">login</span><span class="p">(</span><span class="n">EMAIL_USERNAME</span><span class="p">,</span> <span class="n">EMAIL_PASSWORD</span><span class="p">)</span>
        <span class="n">server</span><span class="p">.</span><span class="nf">send_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">server</span><span class="p">.</span><span class="nf">quit</span><span class="p">()</span>
        
        <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Email sent to </span><span class="si">{</span><span class="n">to_email</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to send email: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">send_slack_notification</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">danger</span><span class="sh">'</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Slack 알림 발송</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">attachments</span><span class="sh">'</span><span class="p">:</span> <span class="p">[{</span>
                <span class="sh">'</span><span class="s">color</span><span class="sh">'</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())</span>
            <span class="p">}]</span>
        <span class="p">}</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">SLACK_WEBHOOK_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Slack notification sent</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Slack notification failed: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to send Slack notification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/webhook</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">webhook</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Alertmanager 웹훅 엔드포인트</span><span class="sh">"""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span>
    
    <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">alerts</span><span class="sh">'</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">alert_name</span> <span class="o">=</span> <span class="n">alert</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">alertname</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Unknown</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">severity</span> <span class="o">=</span> <span class="n">alert</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">labels</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">alert</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">annotations</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">No description</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">alert</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">annotations</span><span class="sh">'</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">No summary</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># 알림 메시지 생성
</span>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
        🚨 *</span><span class="si">{</span><span class="n">alert_name</span><span class="si">}</span><span class="s">*
        
        *Severity:* </span><span class="si">{</span><span class="n">severity</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="si">}</span><span class="s">
        *Summary:* </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s">
        *Description:* </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s">
        *Time:* </span><span class="si">{</span><span class="n">alert</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">startsAt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Unknown</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="s">
        </span><span class="sh">"""</span>
        
        <span class="c1"># 심각도에 따른 알림 발송
</span>        <span class="k">if</span> <span class="n">severity</span> <span class="o">==</span> <span class="sh">'</span><span class="s">critical</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">send_email</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">CRITICAL: </span><span class="si">{</span><span class="n">alert_name</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">&lt;b&gt;</span><span class="sh">'</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">&lt;/b&gt;</span><span class="sh">'</span><span class="p">),</span>
                <span class="n">to_email</span><span class="o">=</span><span class="sh">'</span><span class="s">admin@example.com</span><span class="sh">'</span>
            <span class="p">)</span>
            <span class="nf">send_slack_notification</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="sh">'</span><span class="s">danger</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">severity</span> <span class="o">==</span> <span class="sh">'</span><span class="s">warning</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">send_slack_notification</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="sh">'</span><span class="s">warning</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Processed alert: </span><span class="si">{</span><span class="n">alert_name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">severity</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">})</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/health</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">health</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">헬스체크 엔드포인트</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">healthy</span><span class="sh">'</span><span class="p">})</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="모니터링-자동화-cron-작업">모니터링 자동화 Cron 작업</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/cron.d/nginx-monitoring</span>

<span class="c"># 실시간 메트릭 수집 (1분마다)</span>
<span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root /usr/local/bin/nginx-log-monitor.sh <span class="o">&gt;&gt;</span> /var/log/nginx/monitoring.log 2&gt;&amp;1

<span class="c"># 상세 성능 분석 (5분마다)</span>
<span class="k">*</span>/5 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root /usr/local/bin/nginx-metrics.sh <span class="o">&gt;&gt;</span> /var/log/nginx/performance.log 2&gt;&amp;1

<span class="c"># 상태 정보 수집 (1분마다)</span>
<span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root /usr/local/bin/nginx-status-parser.sh prometheus <span class="o">&gt;</span> /var/lib/node_exporter/textfile_collector/nginx.prom

<span class="c"># 일일 리포트 생성 (매일 오전 9시)</span>
0 9 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root /usr/local/bin/generate-daily-report.sh | mail <span class="nt">-s</span> <span class="s2">"Daily Nginx Report"</span> admin@example.com

<span class="c"># 로그 정리 (매주 일요일)</span>
0 2 <span class="k">*</span> <span class="k">*</span> 0 root find /var/log/nginx <span class="nt">-name</span> <span class="s2">"*.log"</span> <span class="nt">-mtime</span> +30 <span class="nt">-delete</span>
</code></pre></div></div>

<h2 id="실습-예제">실습 예제</h2>

<h3 id="종합-모니터링-스크립트">종합 모니터링 스크립트</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># /usr/local/bin/nginx-monitoring-suite.sh</span>

<span class="c"># 설정</span>
<span class="nv">PROMETHEUS_URL</span><span class="o">=</span><span class="s2">"http://localhost:9090"</span>
<span class="nv">GRAFANA_URL</span><span class="o">=</span><span class="s2">"http://localhost:3000"</span>
<span class="nv">ALERT_EMAIL</span><span class="o">=</span><span class="s2">"admin@example.com"</span>

<span class="c"># 모든 모니터링 도구 상태 확인</span>
check_monitoring_stack<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"=== Monitoring Stack Health Check ==="</span>
    
    <span class="c"># Prometheus 상태</span>
    <span class="k">if </span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PROMETHEUS_URL</span><span class="s2">/api/v1/query?query=up"</span> <span class="o">&gt;</span> /dev/null<span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"✓ Prometheus is running"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"✗ Prometheus is not accessible"</span>
    <span class="k">fi</span>
    
    <span class="c"># Grafana 상태</span>
    <span class="k">if </span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$GRAFANA_URL</span><span class="s2">/api/health"</span> <span class="o">&gt;</span> /dev/null<span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"✓ Grafana is running"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"✗ Grafana is not accessible"</span>
    <span class="k">fi</span>
    
    <span class="c"># Nginx Exporter 상태</span>
    <span class="k">if </span>curl <span class="nt">-s</span> <span class="s2">"http://localhost:9113/metrics"</span> <span class="o">&gt;</span> /dev/null<span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"✓ Nginx Exporter is running"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"✗ Nginx Exporter is not accessible"</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 현재 알림 상태 확인</span>
check_active_alerts<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">=== Active Alerts ==="</span>
    
    <span class="nb">local </span><span class="nv">alerts</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PROMETHEUS_URL</span><span class="s2">/api/v1/alerts"</span> | jq <span class="nt">-r</span> <span class="s1">'.data.alerts[] | select(.state == "firing") | .labels.alertname'</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$alerts</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"No active alerts"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Active alerts:"</span>
        <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$alerts</span><span class="s2">"</span> | <span class="k">while </span><span class="nb">read </span>alert<span class="p">;</span> <span class="k">do
            </span><span class="nb">echo</span> <span class="s2">"  - </span><span class="nv">$alert</span><span class="s2">"</span>
        <span class="k">done
    fi</span>
<span class="o">}</span>

<span class="c"># 성능 요약</span>
performance_summary<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">=== Performance Summary ==="</span>
    
    <span class="c"># Prometheus 쿼리를 통한 메트릭 수집</span>
    <span class="nb">local </span><span class="nv">rps</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PROMETHEUS_URL</span><span class="s2">/api/v1/query?query=rate(nginx_requests_total[5m])"</span> | jq <span class="nt">-r</span> <span class="s1">'.data.result[0].value[1] // 0'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">error_rate</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PROMETHEUS_URL</span><span class="s2">/api/v1/query?query=rate(nginx_http_requests_total{status=~</span><span class="se">\"</span><span class="s2">5..</span><span class="se">\"</span><span class="s2">}[5m])/rate(nginx_http_requests_total[5m])*100"</span> | jq <span class="nt">-r</span> <span class="s1">'.data.result[0].value[1] // 0'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">active_conn</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PROMETHEUS_URL</span><span class="s2">/api/v1/query?query=nginx_connections_active"</span> | jq <span class="nt">-r</span> <span class="s1">'.data.result[0].value[1] // 0'</span><span class="si">)</span>
    
    <span class="nb">printf</span> <span class="s2">"Requests per second: %.2f</span><span class="se">\n</span><span class="s2">"</span> <span class="nv">$rps</span>
    <span class="nb">printf</span> <span class="s2">"Error rate: %.2f%%</span><span class="se">\n</span><span class="s2">"</span> <span class="nv">$error_rate</span>
    <span class="nb">printf</span> <span class="s2">"Active connections: %.0f</span><span class="se">\n</span><span class="s2">"</span> <span class="nv">$active_conn</span>
<span class="o">}</span>

check_monitoring_stack
check_active_alerts
performance_summary
</code></pre></div></div>

<h2 id="다음-단계">다음 단계</h2>

<p>다음 포스트에서는 다음 내용을 다루겠습니다:</p>

<ul>
  <li>백업 및 복구 전략</li>
  <li>무중단 업그레이드 방법</li>
  <li>장애 대응 및 복구 절차</li>
  <li>성능 튜닝 고급 기법</li>
</ul>

<h2 id="참고-자료">참고 자료</h2>

<ul>
  <li><a href="https://github.com/nginxinc/nginx-prometheus-exporter">Prometheus Nginx Exporter</a></li>
  <li><a href="https://grafana.com/grafana/dashboards/12708">Grafana Nginx Dashboard</a></li>
  <li><a href="https://prometheus.io/docs/alerting/latest/alertmanager/">Alertmanager Configuration</a></li>
</ul>

  </div>

  <footer class="post-footer">
    <div class="post-navigation"><div class="nav-previous">
        <a href="/infra-blog/blog/2024/06/10/nginx-operations-guide-part1.html" rel="prev">
          <i class="icon-left-arrow"></i>
          <span class="nav-title">Nginx 운영 가이드 Part 1 - 프로세스 관리, 서비스 제어, 로그 관리</span>
        </a>
      </div><div class="nav-next">
        <a href="/infra-blog/blog/2024/06/12/nginx-operations-guide-part3.html" rel="next">
          <span class="nav-title">Nginx 운영 가이드 Part 3 - 백업/복구, 업그레이드, 장애 대응</span>
          <i class="icon-right-arrow"></i>
        </a>
      </div></div>
  </footer>
  </article></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://github.com/leeyonghe" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/lee-yong-hee-18912454/" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><!----></ul><p class="about-footer condensed">&copy;
        2025</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </footer>
  </main>
  
  <script type="text/javascript" src="/infra-blog/assets/js/darkmode.js"></script>
  
  <script src="/infra-blog/assets/js/simple-jekyll-search.min.js"></script>
  <script src="/infra-blog/assets/js/search.js"></script>
  
</body>

</html>
