<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/infra-blog/assets/css/style.css">
<link rel="stylesheet" href="/infra-blog/assets/css/post-detail.css">
<style>
/* Post Detail Page Styling */
.post-container article {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  padding: 40px;
  margin: 30px auto;
  max-width: 800px;
}

@media screen and (max-width: 768px) {
  .post-container article {
    margin: 20px;
    padding: 25px;
    border-radius: 8px;
  }
}

.post-container article .post-header {
  border-bottom: 2px solid #f5f5f5;
  padding-bottom: 25px;
  margin-bottom: 30px;
}

.post-container article .post-header .post-title {
  font-size: 2.2em;
  font-weight: 700;
  color: #2c3e50;
  line-height: 1.3;
  margin-bottom: 15px;
}

@media screen and (max-width: 768px) {
  .post-container article .post-header .post-title {
    font-size: 1.8em;
  }
}

.post-container article .post-header .post-meta {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.post-container article .post-header .post-meta .post-date {
  display: flex;
  align-items: center;
  color: #666;
  font-size: 0.9em;
}

.post-container article .post-header .post-meta .post-date i {
  margin-right: 8px;
  color: #888;
}

.post-container article .post-header .post-meta .post-categories-wrapper {
  display: flex;
  align-items: center;
}

.post-container article .post-header .post-meta .post-categories-wrapper i {
  margin-right: 8px;
  color: #888;
}

.post-container article .post-header .post-meta .post-categories-wrapper .post-categories {
  display: flex;
  gap: 8px;
  list-style: none;
  margin: 0;
  padding: 0;
}

.post-container article .post-header .post-meta .post-categories-wrapper .post-categories li {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8em;
  font-weight: 500;
  text-transform: capitalize;
}

.post-container article .post-content {
  font-size: 1.1em;
  line-height: 1.8;
  color: #333;
}

.post-container article .post-content p {
  margin-bottom: 1.2em;
}

.post-container article .post-content h1,
.post-container article .post-content h2,
.post-container article .post-content h3,
.post-container article .post-content h4,
.post-container article .post-content h5,
.post-container article .post-content h6 {
  color: #2c3e50;
  margin: 1.5em 0 0.8em 0;
  font-weight: 600;
}

.post-container article .post-content h2 {
  font-size: 1.8em;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

.post-container article .post-content h3 {
  font-size: 1.5em;
  color: #34495e;
}

.post-container article .post-content code {
  background: #f8f9fa;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
  color: #e74c3c;
}

.post-container article .post-content pre {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 15px;
  overflow-x: auto;
  margin: 1.5em 0;
}

.post-container article .post-content pre code {
  background: none;
  color: #333;
  padding: 0;
}

.post-container article .post-content blockquote {
  border-left: 4px solid #3498db;
  background: #f8f9fa;
  padding: 15px 20px;
  margin: 1.5em 0;
  font-style: italic;
  color: #555;
}

.post-container article .post-content img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1.5em 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.post-container article .post-content ul,
.post-container article .post-content ol {
  padding-left: 1.5em;
  margin-bottom: 1.2em;
}

.post-container article .post-content ul li,
.post-container article .post-content ol li {
  margin-bottom: 0.5em;
}

.post-container article .post-content a {
  color: #3498db;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: all 0.3s ease;
}

.post-container article .post-content a:hover {
  border-bottom-color: #3498db;
}

.post-container article .post-footer {
  border-top: 2px solid #f5f5f5;
  padding-top: 25px;
  margin-top: 40px;
}

.post-container article .post-footer .post-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
}

@media screen and (max-width: 768px) {
  .post-container article .post-footer .post-navigation {
    flex-direction: column;
    gap: 15px;
  }
}

.post-container article .post-footer .post-navigation .nav-previous,
.post-container article .post-footer .post-navigation .nav-next {
  flex: 1;
}

.post-container article .post-footer .post-navigation .nav-previous a,
.post-container article .post-footer .post-navigation .nav-next a {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  background: #f8f9fa;
  border-radius: 8px;
  text-decoration: none;
  color: #333;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.post-container article .post-footer .post-navigation .nav-previous a:hover,
.post-container article .post-footer .post-navigation .nav-next a:hover {
  background: #e9ecef;
  border-color: #3498db;
  transform: translateY(-2px);
}

.post-container article .post-footer .post-navigation .nav-previous a i,
.post-container article .post-footer .post-navigation .nav-next a i {
  color: #3498db;
  margin: 0 8px;
}

.post-container article .post-footer .post-navigation .nav-previous a .nav-title,
.post-container article .post-footer .post-navigation .nav-next a .nav-title {
  font-weight: 500;
}

.post-container article .post-footer .post-navigation .nav-previous a {
  justify-content: flex-start;
}

.post-container article .post-footer .post-navigation .nav-next a {
  justify-content: flex-end;
  text-align: right;
}
</style>
<title>배포 전략 완전 가이드 | Complete Deployment Strategies Guide</title>

<script type="text/javascript" src="/infra-blog/assets/js/darkmode.js"></script>

</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/infra-blog/">
        
        <img src="/infra-blog/assets/portfolio.png" alt="Infrastructure Engineer" />
        
      </a>
      <h2 id="title">
        <a href="/infra-blog/">Infrastructure Engineer</a>
      </h2>
      </div><p class="tagline">DevOps & Cloud Infrastructure Specialist</p></div>
      
      <ul class="social about-footer condensed"><a href="https://github.com/leeyonghe" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/lee-yong-hee-18912454/" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><!----></ul><p class="about-footer condensed">&copy;
        2025</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </section>
    <section class="content">
      <style>
/* Post Detail Page Styling - Direct Inline */
.post-container article {
  background: #fff !important;
  border: none !important;
  border-top: none !important;
  border-right: none !important;
  border-bottom: none !important;
  border-left: none !important;
  border-width: 0 !important;
  border-style: none !important;
  outline: none !important;
  border-radius: 12px !important;
  box-shadow: none !important;
  padding: 40px !important;
  margin: 30px auto !important;
  max-width: 800px !important;
}

.post-container article .post-header .post-title {
  font-size: 2.2em !important;
  font-weight: 700 !important;
  color: #2c3e50 !important;
  line-height: 1.3 !important;
}

.post-container article .post-header {
  border-bottom: none !important;
  padding-bottom: 25px !important;
  margin-bottom: 30px !important;
}

.post-container article .post-content {
  font-size: 1.1em !important;
  line-height: 1.8 !important;
  color: #333 !important;
}

.post-container article .post-content h2 {
  font-size: 1.8em !important;
  border-bottom: none !important;
  padding-bottom: 10px !important;
  color: #2c3e50 !important;
}

.post-container article .post-header .post-meta .post-categories li {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  color: white !important;
  padding: 4px 12px !important;
  border-radius: 20px !important;
  font-size: 0.8em !important;
  list-style: none !important;
  display: inline-block !important;
  margin-right: 8px !important;
}

.post-container article .post-footer {
  border-top: none !important;
  padding-top: 25px !important;
  margin-top: 40px !important;
}

/* 모든 border와 box-shadow 강제 제거 */
.post-container article *,
.post-container article *::before,
.post-container article *::after {
  border: none !important;
  border-top: none !important;
  border-right: none !important;
  border-bottom: none !important;
  border-left: none !important;
  border-width: 0 !important;
  border-style: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* 코드 블록과 pre 태그도 border, box-shadow 제거 */
.post-container article pre,
.post-container article code,
.post-container article .highlight,
.post-container article .highlighter-rouge {
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}
</style><div class="post-container">
  <article>
    <header class="post-header">
    <h1 class="post-title">배포 전략 완전 가이드 | Complete Deployment Strategies Guide</h1>
    <div class="post-meta">
      <div class="post-date">
        <i class="icon-calendar"></i>
        <time datetime="2024-11-04T01:00:00+00:00">Nov 4, 2024</time>
      </div><div class="post-categories-wrapper">
        <i class="icon-tag"></i>
        <ul class="post-categories"><li>DevOps</li><li>Deployment</li></ul>
      </div></div>
  </header>

  <div class="post-content">
    <p>현대적인 소프트웨어 개발에서 배포는 단순히 코드를 서버에 올리는 것이 아닙니다. 안정적이고 예측 가능한 배포 전략을 통해 서비스 중단을 최소화하고 사용자 경험을 보장하는 것이 핵심입니다.</p>

<h2 id="3-1-배포--deployment">3-1 배포 | Deployment</h2>

<h3 id="3-1-1-배포-자동화--deployment-automation">3-1-1 배포 자동화 | Deployment Automation</h3>

<p>배포 자동화는 소프트웨어 릴리스 과정을 체계화하고 인간의 실수를 최소화하여 안정적인 서비스 운영을 보장합니다.</p>

<h4 id="-배포-자동화의-핵심-개념">🚀 배포 자동화의 핵심 개념</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 자동화 구성 요소</span>
1. 소스 코드 관리 <span class="o">(</span>SCM<span class="o">)</span>
   - Git, SVN
   - 브랜치 전략 <span class="o">(</span>Git Flow, GitHub Flow<span class="o">)</span>

2. 빌드 자동화
   - 컴파일, 패키징
   - 테스트 실행
   - 아티팩트 생성

3. 배포 파이프라인
   - 단계별 배포 <span class="o">(</span>Dev → Staging → Production<span class="o">)</span>
   - 승인 프로세스
   - 롤백 메커니즘

4. 인프라 자동화
   - IaC <span class="o">(</span>Infrastructure as Code<span class="o">)</span>
   - 컨테이너화
   - 오케스트레이션
</code></pre></div></div>

<h4 id="cicd-파이프라인-설계">CI/CD 파이프라인 설계</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># .gitlab-ci.yml - GitLab CI/CD 파이프라인</span>
<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">build</span>
  <span class="pi">-</span> <span class="s">test</span>
  <span class="pi">-</span> <span class="s">security</span>
  <span class="pi">-</span> <span class="s">deploy-staging</span>
  <span class="pi">-</span> <span class="s">deploy-production</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">DOCKER_DRIVER</span><span class="pi">:</span> <span class="s">overlay2</span>
  <span class="na">DOCKER_HOST</span><span class="pi">:</span> <span class="s">tcp://docker:2376</span>
  <span class="na">DOCKER_TLS_CERTDIR</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/certs"</span>

<span class="na">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">echo "Pipeline started at $(date)"</span>
  <span class="pi">-</span> <span class="s">docker info</span>

<span class="c1"># 빌드 단계</span>
<span class="na">build</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">node:16-alpine</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm ci --only=production</span>
    <span class="pi">-</span> <span class="s">npm run build</span>
    <span class="pi">-</span> <span class="s">docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .</span>
    <span class="pi">-</span> <span class="s">docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">dist/</span>
    <span class="na">expire_in</span><span class="pi">:</span> <span class="s">1 hour</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">main</span>
    <span class="pi">-</span> <span class="s">develop</span>

<span class="c1"># 테스트 단계</span>
<span class="na">unit-test</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">node:16-alpine</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm ci</span>
    <span class="pi">-</span> <span class="s">npm run test:unit</span>
    <span class="pi">-</span> <span class="s">npm run test:coverage</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">reports</span><span class="pi">:</span>
      <span class="na">junit</span><span class="pi">:</span> <span class="s">junit.xml</span>
      <span class="na">coverage_report</span><span class="pi">:</span>
        <span class="na">coverage_format</span><span class="pi">:</span> <span class="s">cobertura</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">coverage/cobertura-coverage.xml</span>
  <span class="na">coverage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/Lines\s*:\s*(\d+\.\d+)%/'</span>

<span class="na">integration-test</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">postgres:13</span>
    <span class="pi">-</span> <span class="s">redis:6</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">POSTGRES_DB</span><span class="pi">:</span> <span class="s">testdb</span>
    <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">test</span>
    <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm run test:integration</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">main</span>

<span class="c1"># 보안 스캔</span>
<span class="na">security-scan</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">security</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">owasp/zap2docker-stable</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">zap-baseline.py -t http://localhost:3000 -J zap-report.json</span>
    <span class="pi">-</span> <span class="s">npm audit --audit-level high</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">reports</span><span class="pi">:</span>
      <span class="na">sast</span><span class="pi">:</span> <span class="s">zap-report.json</span>
  <span class="na">allow_failure</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># 스테이징 배포</span>
<span class="na">deploy-staging</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy-staging</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">alpine/helm:3.8.0</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">helm upgrade --install myapp-staging ./helm-chart</span>
      <span class="s">--namespace staging</span>
      <span class="s">--set image.tag=$CI_COMMIT_SHA</span>
      <span class="s">--set ingress.host=staging.myapp.com</span>
      <span class="s">--wait</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">staging</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://staging.myapp.com</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">develop</span>

<span class="c1"># 프로덕션 배포 (수동 승인 필요)</span>
<span class="na">deploy-production</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy-production</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">alpine/helm:3.8.0</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">helm upgrade --install myapp-prod ./helm-chart</span>
      <span class="s">--namespace production</span>
      <span class="s">--set image.tag=$CI_COMMIT_SHA</span>
      <span class="s">--set ingress.host=myapp.com</span>
      <span class="s">--set replicas=3</span>
      <span class="s">--wait</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">production</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://myapp.com</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">main</span>
</code></pre></div></div>

<h4 id="jenkins-파이프라인-구성">Jenkins 파이프라인 구성</h4>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Jenkinsfile - Jenkins 선언적 파이프라인</span>
<span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">DOCKER_REGISTRY</span> <span class="o">=</span> <span class="s1">'your-registry.com'</span>
        <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s1">'myapp'</span>
        <span class="n">KUBECONFIG</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">(</span><span class="s1">'kubeconfig-prod'</span><span class="o">)</span>
    <span class="o">}</span>
    
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">checkout</span> <span class="n">scm</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">env</span><span class="o">.</span><span class="na">GIT_COMMIT_SHORT</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span>
                        <span class="nl">script:</span> <span class="s1">'git rev-parse --short HEAD'</span><span class="o">,</span>
                        <span class="nl">returnStdout:</span> <span class="kc">true</span>
                    <span class="o">).</span><span class="na">trim</span><span class="o">()</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Build &amp; Test'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">'Unit Tests'</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">'npm ci'</span>
                        <span class="n">sh</span> <span class="s1">'npm run test:unit'</span>
                    <span class="o">}</span>
                    <span class="n">post</span> <span class="o">{</span>
                        <span class="n">always</span> <span class="o">{</span>
                            <span class="n">publishTestResults</span> <span class="nl">testResultsPattern:</span> <span class="s1">'test-results.xml'</span>
                            <span class="n">publishCoverage</span> <span class="nl">adapters:</span> <span class="o">[</span>
                                <span class="n">coberturaAdapter</span><span class="o">(</span><span class="s1">'coverage/cobertura-coverage.xml'</span><span class="o">)</span>
                            <span class="o">]</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                
                <span class="n">stage</span><span class="o">(</span><span class="s1">'Security Scan'</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">'npm audit'</span>
                        <span class="n">sh</span> <span class="s1">'docker run --rm -v $(pwd):/app clair-scanner --ip $(hostname -i) myapp:latest'</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Build Docker Image'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="kt">def</span> <span class="n">image</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">"${DOCKER_REGISTRY}/${APP_NAME}:${env.GIT_COMMIT_SHORT}"</span><span class="o">)</span>
                    <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">"https://${DOCKER_REGISTRY}"</span><span class="o">,</span> <span class="s1">'docker-registry-credentials'</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">image</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="n">image</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s1">'latest'</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Deploy to Staging'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">"""
                    helm upgrade --install ${APP_NAME}-staging ./helm-chart \\
                        --namespace staging \\
                        --set image.tag=${env.GIT_COMMIT_SHORT} \\
                        --wait --timeout=600s
                """</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Integration Tests'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">'npm run test:integration -- --env=staging'</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Deploy to Production'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">branch</span> <span class="s1">'main'</span>
            <span class="o">}</span>
            <span class="n">input</span> <span class="o">{</span>
                <span class="n">message</span> <span class="s2">"Deploy to production?"</span>
                <span class="n">ok</span> <span class="s2">"Deploy"</span>
                <span class="n">parameters</span> <span class="o">{</span>
                    <span class="n">choice</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">'DEPLOYMENT_STRATEGY'</span><span class="o">,</span> <span class="nl">choices:</span> <span class="o">[</span><span class="s1">'rolling'</span><span class="o">,</span> <span class="s1">'blue-green'</span><span class="o">,</span> <span class="s1">'canary'</span><span class="o">])</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="k">switch</span><span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">DEPLOYMENT_STRATEGY</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="s1">'blue-green'</span><span class="o">:</span>
                            <span class="n">sh</span> <span class="s1">'./scripts/blue-green-deploy.sh ${env.GIT_COMMIT_SHORT}'</span>
                            <span class="k">break</span>
                        <span class="k">case</span> <span class="s1">'canary'</span><span class="o">:</span>
                            <span class="n">sh</span> <span class="s1">'./scripts/canary-deploy.sh ${env.GIT_COMMIT_SHORT}'</span>
                            <span class="k">break</span>
                        <span class="nl">default:</span>
                            <span class="n">sh</span> <span class="s2">"""
                                helm upgrade --install ${APP_NAME}-prod ./helm-chart \\
                                    --namespace production \\
                                    --set image.tag=${env.GIT_COMMIT_SHORT} \\
                                    --wait --timeout=600s
                            """</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="n">slackSend</span><span class="o">(</span>
                    <span class="nl">channel:</span> <span class="s1">'#deployments'</span><span class="o">,</span>
                    <span class="nl">color:</span> <span class="s1">'danger'</span><span class="o">,</span>
                    <span class="nl">message:</span> <span class="s2">"❌ Deployment failed: ${env.JOB_NAME} ${env.BUILD_NUMBER}"</span>
                <span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="n">slackSend</span><span class="o">(</span>
                    <span class="nl">channel:</span> <span class="s1">'#deployments'</span><span class="o">,</span>
                    <span class="nl">color:</span> <span class="s1">'good'</span><span class="o">,</span>
                    <span class="nl">message:</span> <span class="s2">"✅ Deployment successful: ${env.JOB_NAME} ${env.BUILD_NUMBER}"</span>
                <span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="3-1-2-배포-자동화-도구-선택--deployment-automation-tools">3-1-2 배포 자동화 도구 선택 | Deployment Automation Tools</h3>

<h4 id="️-도구-비교-매트릭스">🛠️ 도구 비교 매트릭스</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CI/CD 플랫폼 비교</span>
                GitLab CI    Jenkins     GitHub Actions    Azure DevOps    AWS CodePipeline
설정 복잡도        낮음        중간           낮음            중간              높음
클라우드 통합      우수        보통           우수            우수              우수  
온프레미스 지원    우수        우수           제한적          우수              불가
비용              무료/유료    오픈소스       무료/유료        유료              사용량기반
확장성            우수        우수           우수            우수              우수
커뮤니티 지원      우수        최고           우수            보통              보통

<span class="c"># 컨테이너 오케스트레이션</span>
                Kubernetes   Docker Swarm   OpenShift      Nomad           ECS/Fargate
학습 곡선          가파름       완만          중간           완만             완만
기능 풍부함        최고        기본           우수           기본             기본
클라우드 지원      우수        보통           우수           보통             AWS전용
커뮤니티          최고        감소           보통           성장             AWS생태계
</code></pre></div></div>

<h4 id="github-actions-워크플로우">GitHub Actions 워크플로우</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># .github/workflows/deploy.yml</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Application</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">,</span> <span class="nv">develop</span><span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>

<span class="na">env</span><span class="pi">:</span>
  <span class="na">REGISTRY</span><span class="pi">:</span> <span class="s">ghcr.io</span>
  <span class="na">IMAGE_NAME</span><span class="pi">:</span> <span class="s">$</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">test</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">node-version</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">16.x</span><span class="pi">,</span> <span class="nv">18.x</span><span class="pi">]</span>
    
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup Node.js $</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v3</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">node-version</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">cache</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">npm ci</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run tests</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">npm run test:unit</span>
        <span class="s">npm run test:integration</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload coverage reports</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">codecov/codecov-action@v3</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">file</span><span class="pi">:</span> <span class="s">./coverage/lcov.info</span>

  <span class="na">build</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">test</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">$</span>
      <span class="na">digest</span><span class="pi">:</span> <span class="s">$</span>
    
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repository</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup Docker Buildx</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v2</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Log in to Container Registry</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">registry</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">$</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Extract metadata</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">meta</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/metadata-action@v4</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">images</span><span class="pi">:</span> <span class="s">$/$</span>
        <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">type=ref,event=branch</span>
          <span class="s">type=ref,event=pr</span>
          <span class="s">type=sha,prefix=-</span>
    
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push Docker image</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">build</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v4</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
        <span class="na">push</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">tags</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">labels</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">cache-from</span><span class="pi">:</span> <span class="s">type=gha</span>
        <span class="na">cache-to</span><span class="pi">:</span> <span class="s">type=gha,mode=max</span>

  <span class="na">deploy-staging</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">github.ref == 'refs/heads/develop'</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">build</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">staging</span>
    
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to staging</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/k8s-deploy@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">manifests</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">k8s/staging/deployment.yaml</span>
          <span class="s">k8s/staging/service.yaml</span>
        <span class="na">images</span><span class="pi">:</span> <span class="s">$@$</span>
        <span class="na">namespace</span><span class="pi">:</span> <span class="s">staging</span>

  <span class="na">deploy-production</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">github.ref == 'refs/heads/main'</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">build</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">production</span>
    
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to production</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/k8s-deploy@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">manifests</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">k8s/production/deployment.yaml</span>
          <span class="s">k8s/production/service.yaml</span>
        <span class="na">images</span><span class="pi">:</span> <span class="s">$@$</span>
        <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">blue-green</span>
</code></pre></div></div>

<h4 id="argocd-gitops-워크플로우">ArgoCD GitOps 워크플로우</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># argocd-app.yaml - ArgoCD Application 정의</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">argoproj.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Application</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-production</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">argocd</span>
  <span class="na">finalizers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">resources-finalizer.argocd.argoproj.io</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s">default</span>
  
  <span class="na">source</span><span class="pi">:</span>
    <span class="na">repoURL</span><span class="pi">:</span> <span class="s">https://github.com/company/myapp-k8s-manifests</span>
    <span class="na">targetRevision</span><span class="pi">:</span> <span class="s">HEAD</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">overlays/production</span>
    
  <span class="na">destination</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://kubernetes.default.svc</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
    
  <span class="na">syncPolicy</span><span class="pi">:</span>
    <span class="na">automated</span><span class="pi">:</span>
      <span class="na">prune</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">selfHeal</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">allowEmpty</span><span class="pi">:</span> <span class="kc">false</span>
    <span class="na">syncOptions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">CreateNamespace=true</span>
      <span class="pi">-</span> <span class="s">PrunePropagationPolicy=foreground</span>
      <span class="pi">-</span> <span class="s">PruneLast=true</span>
      
  <span class="na">revisionHistoryLimit</span><span class="pi">:</span> <span class="m">10</span>
  
  <span class="c1"># Health checks</span>
  <span class="na">ignoreDifferences</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">group</span><span class="pi">:</span> <span class="s">apps</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">jsonPointers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/spec/replicas</span>

<span class="nn">---</span>
<span class="c1"># kustomization.yaml - Kustomize 설정</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>

<span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>

<span class="na">resources</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">../../base</span>

<span class="na">patchesStrategicMerge</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">deployment-patch.yaml</span>
<span class="pi">-</span> <span class="s">service-patch.yaml</span>

<span class="na">images</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
  <span class="na">newTag</span><span class="pi">:</span> <span class="s">v1.2.3</span>

<span class="na">replicas</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-deployment</span>
  <span class="na">count</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">configMapGenerator</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-config</span>
  <span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">config/production.yaml</span>

<span class="na">secretGenerator</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-secrets</span>
  <span class="na">files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">secrets/database.env</span>
</code></pre></div></div>

<h2 id="3-2-배포-전략--deployment-strategies">3-2 배포 전략 | Deployment Strategies</h2>

<h3 id="3-2-1-가장-간단한-배포--recreate-deployment">3-2-1 가장 간단한 배포 | Recreate Deployment</h3>

<p>Recreate 배포는 기존 버전을 완전히 중단한 후 새 버전을 시작하는 가장 단순한 배포 방식입니다.</p>

<h4 id="-recreate-배포-특징">📋 Recreate 배포 특징</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 장점</span>
- 구현이 간단함
- 리소스 사용량이 적음
- 버전 간 충돌 없음
- 데이터베이스 마이그레이션에 유리

<span class="c"># 단점  </span>
- 서비스 중단 시간 발생
- 사용자 경험 저하
- 롤백 시간이 김
</code></pre></div></div>

<h4 id="kubernetes-recreate-배포">Kubernetes Recreate 배포</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># recreate-deployment.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-recreate</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>  <span class="c1"># Recreate 전략 사용</span>
    
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
      
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v2.0.0</span>
        
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myapp:v2.0.0</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        
        <span class="c1"># 헬스체크 설정</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/ready</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
          
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">256Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">512Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
</code></pre></div></div>

<h4 id="recreate-배포-스크립트">Recreate 배포 스크립트</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># recreate-deploy.sh</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"myapp"</span>
<span class="nv">NEW_VERSION</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">"production"</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;new-version&gt;"</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"=== Recreate Deployment Started ==="</span>
<span class="nb">echo</span> <span class="s2">"App: </span><span class="nv">$APP_NAME</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"New Version: </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Namespace: </span><span class="nv">$NAMESPACE</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Time: </span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">"</span>

<span class="c"># 1. 현재 배포 상태 확인</span>
<span class="nb">echo</span> <span class="s2">"Current deployment status:"</span>
kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span>

<span class="c"># 2. 헬스체크 엔드포인트 확인</span>
<span class="nb">echo</span> <span class="s2">"Checking current health status..."</span>
kubectl get pods <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span><span class="nv">$APP_NAME</span>

<span class="c"># 3. 트래픽 중단 (로드밸런서에서 제거)</span>
<span class="nb">echo</span> <span class="s2">"Removing from load balancer..."</span>
kubectl patch service <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-p</span> <span class="s1">'{"spec":{"selector":{"app":"maintenance"}}}'</span>

<span class="c"># 4. 기존 파드 종료 대기</span>
<span class="nb">echo</span> <span class="s2">"Stopping existing pods..."</span>
kubectl delete pods <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span><span class="nv">$APP_NAME</span> <span class="nt">--grace-period</span><span class="o">=</span>30

<span class="c"># 5. 새 버전으로 업데이트</span>
<span class="nb">echo</span> <span class="s2">"Updating to new version: </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
kubectl <span class="nb">set </span>image deployment/<span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nv">container</span><span class="o">=</span><span class="nv">$APP_NAME</span>:<span class="nv">$NEW_VERSION</span>

<span class="c"># 6. 배포 완료 대기</span>
<span class="nb">echo</span> <span class="s2">"Waiting for deployment to complete..."</span>
kubectl rollout status deployment/<span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">--timeout</span><span class="o">=</span>300s

<span class="c"># 7. 헬스체크 확인</span>
<span class="nb">echo</span> <span class="s2">"Performing health checks..."</span>
<span class="nb">sleep </span>30

<span class="nv">READY_REPLICAS</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.readyReplicas}'</span><span class="si">)</span>
<span class="nv">DESIRED_REPLICAS</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.replicas}'</span><span class="si">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$READY_REPLICAS</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Health check passed: </span><span class="nv">$READY_REPLICAS</span><span class="s2">/</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2"> pods ready"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Health check failed: </span><span class="nv">$READY_REPLICAS</span><span class="s2">/</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2"> pods ready"</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># 8. 트래픽 복원</span>
<span class="nb">echo</span> <span class="s2">"Restoring traffic..."</span>
kubectl patch service <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-p</span> <span class="s1">'{"spec":{"selector":{"app":"'</span><span class="nv">$APP_NAME</span><span class="s1">'"}}}'</span>

<span class="nb">echo</span> <span class="s2">"=== Recreate Deployment Completed Successfully ==="</span>
</code></pre></div></div>

<h3 id="3-2-2-롤링-업데이트--rolling-update">3-2-2 롤링 업데이트 | Rolling Update</h3>

<p>롤링 업데이트는 서비스 중단 없이 점진적으로 새 버전을 배포하는 방식입니다.</p>

<h4 id="-롤링-업데이트-원리">🔄 롤링 업데이트 원리</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rolling-update-deployment.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-rolling</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">6</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>      <span class="c1"># 최대 1개 파드 중단 허용</span>
      <span class="na">maxSurge</span><span class="pi">:</span> <span class="m">2</span>           <span class="c1"># 최대 2개 추가 파드 생성 허용</span>
      
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
      
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myapp:v2.1.0</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        
        <span class="c1"># 점진적 종료를 위한 설정</span>
        <span class="na">lifecycle</span><span class="pi">:</span>
          <span class="na">preStop</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">sleep</span><span class="nv"> </span><span class="s">15"</span><span class="pi">]</span>
              
        <span class="c1"># 빠른 시작을 위한 헬스체크</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/ready</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">2</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">3</span>
          
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>  
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
</code></pre></div></div>

<h4 id="고급-롤링-업데이트-스크립트">고급 롤링 업데이트 스크립트</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># advanced-rolling-update.sh</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"myapp"</span>
<span class="nv">NEW_VERSION</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">"production"</span>
<span class="nv">MAX_ROLLBACK_REVISION</span><span class="o">=</span>5

<span class="c"># 컬러 출력을 위한 함수</span>
<span class="nv">RED</span><span class="o">=</span><span class="s1">'\033[0;31m'</span>
<span class="nv">GREEN</span><span class="o">=</span><span class="s1">'\033[0;32m'</span>
<span class="nv">YELLOW</span><span class="o">=</span><span class="s1">'\033[1;33m'</span>
<span class="nv">NC</span><span class="o">=</span><span class="s1">'\033[0m'</span> <span class="c"># No Color</span>

log<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">GREEN</span><span class="k">}</span><span class="s2">[</span><span class="si">$(</span><span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="si">)</span><span class="s2">]</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

warn<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">YELLOW</span><span class="k">}</span><span class="s2">[WARNING]</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

error<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">RED</span><span class="k">}</span><span class="s2">[ERROR]</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># 사전 점검</span>
pre_deployment_checks<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"Performing pre-deployment checks..."</span>
    
    <span class="c"># 1. 새 이미지 존재 확인</span>
    <span class="k">if</span> <span class="o">!</span> docker pull <span class="nv">$APP_NAME</span>:<span class="nv">$NEW_VERSION</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"Image </span><span class="nv">$APP_NAME</span><span class="s2">:</span><span class="nv">$NEW_VERSION</span><span class="s2"> not found"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># 2. 클러스터 상태 확인</span>
    <span class="k">if</span> <span class="o">!</span> kubectl cluster-info <span class="o">&gt;</span> /dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"Cannot connect to Kubernetes cluster"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># 3. 네임스페이스 존재 확인</span>
    <span class="k">if</span> <span class="o">!</span> kubectl get namespace <span class="nv">$NAMESPACE</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"Namespace </span><span class="nv">$NAMESPACE</span><span class="s2"> does not exist"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># 4. 현재 배포 상태 확인</span>
    <span class="nv">CURRENT_REPLICAS</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.readyReplicas}'</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"0"</span><span class="si">)</span>
    <span class="nv">DESIRED_REPLICAS</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.replicas}'</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"0"</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CURRENT_REPLICAS</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>warn <span class="s2">"Current deployment is not healthy: </span><span class="nv">$CURRENT_REPLICAS</span><span class="s2">/</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2"> pods ready"</span>
        <span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"Continue anyway? (y/N): "</span> <span class="nt">-n</span> 1 <span class="nt">-r</span>
        <span class="nb">echo
        </span><span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$REPLY</span> <span class="o">=</span>~ ^[Yy]<span class="nv">$ </span><span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">exit </span>1
        <span class="k">fi
    fi
    
    </span>log <span class="s2">"Pre-deployment checks completed successfully"</span>
<span class="o">}</span>

<span class="c"># 배포 실행</span>
perform_rolling_update<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"Starting rolling update to version </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
    
    <span class="c"># 현재 이미지 태그 저장 (롤백용)</span>
    <span class="nv">CURRENT_IMAGE</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.template.spec.containers[0].image}'</span><span class="si">)</span>
    
    <span class="c"># 배포 히스토리 기록</span>
    kubectl annotate deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="se">\</span>
        deployment.kubernetes.io/revision-history<span class="o">=</span><span class="s2">"Previous: </span><span class="nv">$CURRENT_IMAGE</span><span class="s2">, New: </span><span class="nv">$APP_NAME</span><span class="s2">:</span><span class="nv">$NEW_VERSION</span><span class="s2">, Time: </span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">"</span>
    
    <span class="c"># 새 버전 배포</span>
    kubectl <span class="nb">set </span>image deployment/<span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nv">$APP_NAME</span><span class="o">=</span><span class="nv">$APP_NAME</span>:<span class="nv">$NEW_VERSION</span>
    
    <span class="c"># 배포 상태 모니터링</span>
    log <span class="s2">"Monitoring rollout progress..."</span>
    
    <span class="c"># 타임아웃과 함께 롤아웃 상태 확인</span>
    <span class="k">if </span><span class="nb">timeout </span>600 kubectl rollout status deployment/<span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span><span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"Rolling update completed successfully"</span>
    <span class="k">else
        </span>error <span class="s2">"Rolling update timed out"</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 배포 후 검증</span>
post_deployment_validation<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"Performing post-deployment validation..."</span>
    
    <span class="c"># 1. 파드 상태 확인</span>
    <span class="nb">sleep </span>30
    
    <span class="nv">READY_REPLICAS</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.readyReplicas}'</span><span class="si">)</span>
    <span class="nv">DESIRED_REPLICAS</span><span class="o">=</span><span class="si">$(</span>kubectl get deployment <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.replicas}'</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$READY_REPLICAS</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"Pod readiness check failed: </span><span class="nv">$READY_REPLICAS</span><span class="s2">/</span><span class="nv">$DESIRED_REPLICAS</span><span class="s2">"</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
    
    <span class="c"># 2. 애플리케이션 헬스체크</span>
    <span class="nv">SERVICE_IP</span><span class="o">=</span><span class="si">$(</span>kubectl get service <span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.clusterIP}'</span><span class="si">)</span>
    
    <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do
        if </span>curl <span class="nt">-f</span> <span class="nt">-s</span> http://<span class="nv">$SERVICE_IP</span>:8080/health <span class="o">&gt;</span> /dev/null<span class="p">;</span> <span class="k">then
            </span>log <span class="s2">"Application health check passed"</span>
            <span class="nb">break
        </span><span class="k">else
            </span>warn <span class="s2">"Health check attempt </span><span class="nv">$i</span><span class="s2"> failed, retrying..."</span>
            <span class="nb">sleep </span>5
        <span class="k">fi
        
        if</span> <span class="o">[</span> <span class="nv">$i</span> <span class="nt">-eq</span> 10 <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span>error <span class="s2">"Application health check failed after 10 attempts"</span>
            <span class="k">return </span>1
        <span class="k">fi
    done</span>
    
    <span class="c"># 3. 메모리 및 CPU 사용률 확인</span>
    log <span class="s2">"Checking resource usage..."</span>
    kubectl top pods <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span><span class="nv">$APP_NAME</span>
    
    log <span class="s2">"Post-deployment validation completed successfully"</span>
<span class="o">}</span>

<span class="c"># 롤백 함수</span>
rollback_deployment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">rollback_reason</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
    
    error <span class="s2">"Rolling back deployment due to: </span><span class="nv">$rollback_reason</span><span class="s2">"</span>
    
    kubectl rollout undo deployment/<span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span>
    
    log <span class="s2">"Waiting for rollback to complete..."</span>
    kubectl rollout status deployment/<span class="nv">$APP_NAME</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">--timeout</span><span class="o">=</span>300s
    
    error <span class="s2">"Rollback completed"</span>
<span class="o">}</span>

<span class="c"># 메인 실행 로직</span>
main<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;new-version&gt;"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"=== Rolling Update Started ==="</span>
    log <span class="s2">"App: </span><span class="nv">$APP_NAME</span><span class="s2">"</span>
    log <span class="s2">"New Version: </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
    log <span class="s2">"Namespace: </span><span class="nv">$NAMESPACE</span><span class="s2">"</span>
    
    <span class="c"># 단계별 실행</span>
    <span class="k">if</span> <span class="o">!</span> pre_deployment_checks<span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"Pre-deployment checks failed"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    if</span> <span class="o">!</span> perform_rolling_update<span class="p">;</span> <span class="k">then
        </span>rollback_deployment <span class="s2">"Rolling update failed"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    if</span> <span class="o">!</span> post_deployment_validation<span class="p">;</span> <span class="k">then
        </span>rollback_deployment <span class="s2">"Post-deployment validation failed"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"=== Rolling Update Completed Successfully ==="</span>
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<h3 id="3-2-3-블루그린-배포--blue-green-deployment">3-2-3 블루그린 배포 | Blue-Green Deployment</h3>

<p>블루그린 배포는 두 개의 동일한 환경을 운영하여 무중단 배포와 즉시 롤백을 가능하게 하는 전략입니다.</p>

<h4 id="-블루그린-배포-개념">🔵🟢 블루그린 배포 개념</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 블루그린 배포 환경 구성</span>
Production Traffic → Load Balancer → Blue Environment <span class="o">(</span>현재 버전<span class="o">)</span>
                                  → Green Environment <span class="o">(</span>새 버전, 대기<span class="o">)</span>

<span class="c"># 배포 과정</span>
1. Green 환경에 새 버전 배포
2. Green 환경 테스트 및 검증  
3. 로드밸런서 트래픽을 Blue → Green으로 전환
4. Blue 환경을 새로운 Green으로 준비
</code></pre></div></div>

<h4 id="kubernetes-블루그린-배포">Kubernetes 블루그린 배포</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># blue-green-service.yaml - 트래픽 라우팅 서비스</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">blue</span>    <span class="c1"># blue 또는 green으로 전환</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>

<span class="nn">---</span>
<span class="c1"># blue-deployment.yaml - Blue 환경</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-blue</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">blue</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">blue</span>
      
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">blue</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myapp:v1.0.0</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">256Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">512Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>

<span class="nn">---</span>
<span class="c1"># green-deployment.yaml - Green 환경</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>  
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-green</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">green</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">green</span>
      
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">green</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myapp:v2.0.0</span>  <span class="c1"># 새 버전</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">256Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">512Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
</code></pre></div></div>

<h3 id="3-2-4-카나리-배포--canary-deployment">3-2-4 카나리 배포 | Canary Deployment</h3>

<p>카나리 배포는 새 버전을 일부 트래픽에만 점진적으로 노출하여 리스크를 최소화하는 배포 전략입니다.</p>

<h4 id="-카나리-배포-구현">🐤 카나리 배포 구현</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># canary-istio.yaml - Istio를 이용한 카나리 배포</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-canary</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">myapp.company.com</span>
  
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
        <span class="na">canary</span><span class="pi">:</span>
          <span class="na">exact</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">myapp-service</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
      
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">myapp-service</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">90</span>    <span class="c1"># 90% 기존 버전</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">myapp-service</span>  
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">10</span>    <span class="c1"># 10% 새 버전</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DestinationRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp-destination</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>

<span class="na">spec</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">myapp-service</span>
  <span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1.0.0</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v2.0.0</span>
</code></pre></div></div>

<h4 id="점진적-카나리-배포-스크립트">점진적 카나리 배포 스크립트</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># progressive-canary.sh</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"myapp"</span>
<span class="nv">NEW_VERSION</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">"production"</span>

<span class="c"># 트래픽 분배 단계 (%)</span>
<span class="nv">CANARY_STAGES</span><span class="o">=(</span>5 10 25 50 75 100<span class="o">)</span>

log<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"[</span><span class="si">$(</span><span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="si">)</span><span class="s2">] </span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># 메트릭 수집 함수</span>
collect_metrics<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">version</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">duration</span><span class="o">=</span><span class="nv">$2</span>
    
    log <span class="s2">"Collecting metrics for version </span><span class="nv">$version</span><span class="s2"> over </span><span class="nv">$duration</span><span class="s2"> seconds"</span>
    
    <span class="c"># Prometheus 메트릭 쿼리</span>
    <span class="nb">local </span><span class="nv">error_rate</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"http://prometheus:9090/api/v1/query"</span> <span class="se">\</span>
        <span class="nt">--data-urlencode</span> <span class="s2">"query=rate(http_requests_total{version=</span><span class="se">\"</span><span class="nv">$version</span><span class="se">\"</span><span class="s2">,status=~</span><span class="se">\"</span><span class="s2">5..</span><span class="se">\"</span><span class="s2">}[</span><span class="k">${</span><span class="nv">duration</span><span class="k">}</span><span class="s2">s]) / rate(http_requests_total{version=</span><span class="se">\"</span><span class="nv">$version</span><span class="se">\"</span><span class="s2">}[</span><span class="k">${</span><span class="nv">duration</span><span class="k">}</span><span class="s2">s]) * 100"</span><span class="si">)</span>
    
    <span class="nb">local </span><span class="nv">response_time</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"http://prometheus:9090/api/v1/query"</span> <span class="se">\</span>
        <span class="nt">--data-urlencode</span> <span class="s2">"query=histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{version=</span><span class="se">\"</span><span class="nv">$version</span><span class="se">\"</span><span class="s2">}[</span><span class="k">${</span><span class="nv">duration</span><span class="k">}</span><span class="s2">s]))"</span><span class="si">)</span>
    
    <span class="nb">local </span><span class="nv">cpu_usage</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"http://prometheus:9090/api/v1/query"</span> <span class="se">\</span>
        <span class="nt">--data-urlencode</span> <span class="s2">"query=avg(rate(container_cpu_usage_seconds_total{pod=~</span><span class="se">\"</span><span class="nv">$APP_NAME</span><span class="s2">-.*</span><span class="se">\"</span><span class="s2">,container=</span><span class="se">\"</span><span class="nv">$APP_NAME</span><span class="se">\"</span><span class="s2">}[</span><span class="k">${</span><span class="nv">duration</span><span class="k">}</span><span class="s2">s])) by (version)"</span><span class="si">)</span>
    
    <span class="c"># JSON 파싱 (jq 필요)</span>
    <span class="nb">local </span><span class="nv">error_rate_value</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$error_rate</span> | jq <span class="nt">-r</span> <span class="s1">'.data.result[0].value[1] // "0"'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">response_time_value</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$response_time</span> | jq <span class="nt">-r</span> <span class="s1">'.data.result[0].value[1] // "0"'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">cpu_usage_value</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$cpu_usage</span> | jq <span class="nt">-r</span> <span class="s1">'.data.result[0].value[1] // "0"'</span><span class="si">)</span>
    
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$error_rate_value</span><span class="s2">,</span><span class="nv">$response_time_value</span><span class="s2">,</span><span class="nv">$cpu_usage_value</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># SLI/SLO 체크</span>
check_slo<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">metrics</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">version</span><span class="o">=</span><span class="nv">$2</span>
    
    <span class="nv">IFS</span><span class="o">=</span><span class="s1">','</span> <span class="nb">read</span> <span class="nt">-r</span> error_rate response_time cpu_usage <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$metrics</span><span class="s2">"</span>
    
    log <span class="s2">"SLO Check for </span><span class="nv">$version</span><span class="s2"> - Error Rate: </span><span class="nv">$error_rate</span><span class="s2">%, Response Time: </span><span class="k">${</span><span class="nv">response_time</span><span class="k">}</span><span class="s2">s, CPU: </span><span class="nv">$cpu_usage</span><span class="s2">"</span>
    
    <span class="c"># SLO 임계값</span>
    <span class="nb">local </span><span class="nv">max_error_rate</span><span class="o">=</span>1.0
    <span class="nb">local </span><span class="nv">max_response_time</span><span class="o">=</span>0.5
    <span class="nb">local </span><span class="nv">max_cpu_usage</span><span class="o">=</span>0.8
    
    <span class="k">if</span> <span class="o">((</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$error_rate</span><span class="s2"> &gt; </span><span class="nv">$max_error_rate</span><span class="s2">"</span> | bc <span class="nt">-l</span><span class="si">)</span> <span class="o">))</span><span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"❌ Error rate SLO violated: </span><span class="nv">$error_rate</span><span class="s2">% &gt; </span><span class="nv">$max_error_rate</span><span class="s2">%"</span>
        <span class="k">return </span>1
    <span class="k">fi
    
    if</span> <span class="o">((</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$response_time</span><span class="s2"> &gt; </span><span class="nv">$max_response_time</span><span class="s2">"</span> | bc <span class="nt">-l</span><span class="si">)</span> <span class="o">))</span><span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"❌ Response time SLO violated: </span><span class="k">${</span><span class="nv">response_time</span><span class="k">}</span><span class="s2">s &gt; </span><span class="k">${</span><span class="nv">max_response_time</span><span class="k">}</span><span class="s2">s"</span>
        <span class="k">return </span>1
    <span class="k">fi
    
    if</span> <span class="o">((</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cpu_usage</span><span class="s2"> &gt; </span><span class="nv">$max_cpu_usage</span><span class="s2">"</span> | bc <span class="nt">-l</span><span class="si">)</span> <span class="o">))</span><span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"❌ CPU usage SLO violated: </span><span class="nv">$cpu_usage</span><span class="s2"> &gt; </span><span class="nv">$max_cpu_usage</span><span class="s2">"</span>
        <span class="k">return </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"✅ All SLOs passed for version </span><span class="nv">$version</span><span class="s2">"</span>
    <span class="k">return </span>0
<span class="o">}</span>

<span class="c"># 트래픽 가중치 업데이트</span>
update_traffic_weight<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">canary_weight</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">stable_weight</span><span class="o">=</span><span class="k">$((</span><span class="m">100</span> <span class="o">-</span> canary_weight<span class="k">))</span>
    
    log <span class="s2">"Updating traffic weights - Stable: </span><span class="nv">$stable_weight</span><span class="s2">%, Canary: </span><span class="nv">$canary_weight</span><span class="s2">%"</span>
    
    kubectl patch virtualservice <span class="nv">$APP_NAME</span><span class="nt">-canary</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">--type</span><span class="o">=</span><span class="s1">'json'</span> <span class="nt">-p</span><span class="o">=</span><span class="s2">"[
        {</span><span class="se">\"</span><span class="s2">op</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">replace</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">path</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">/spec/http/1/route/0/weight</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">value</span><span class="se">\"</span><span class="s2">: </span><span class="nv">$stable_weight</span><span class="s2">},
        {</span><span class="se">\"</span><span class="s2">op</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">replace</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">path</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">/spec/http/1/route/1/weight</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">value</span><span class="se">\"</span><span class="s2">: </span><span class="nv">$canary_weight</span><span class="s2">}
    ]"</span>
<span class="o">}</span>

<span class="c"># 카나리 배포 실행</span>
perform_canary_deployment<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"Starting canary deployment for version </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
    
    <span class="c"># 1. 카나리 버전 배포 (0% 트래픽)</span>
    kubectl <span class="nb">set </span>image deployment/<span class="nv">$APP_NAME</span><span class="nt">-canary</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nv">$APP_NAME</span><span class="o">=</span><span class="nv">$APP_NAME</span>:<span class="nv">$NEW_VERSION</span>
    kubectl rollout status deployment/<span class="nv">$APP_NAME</span><span class="nt">-canary</span> <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">--timeout</span><span class="o">=</span>300s
    
    <span class="c"># 2. 단계별 트래픽 증가</span>
    <span class="k">for </span>stage <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CANARY_STAGES</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
        </span>log <span class="s2">"=== Canary Stage: </span><span class="nv">$stage</span><span class="s2">% traffic ==="</span>
        
        <span class="c"># 트래픽 가중치 업데이트</span>
        update_traffic_weight <span class="nv">$stage</span>
        
        <span class="c"># 안정화 대기</span>
        log <span class="s2">"Waiting for traffic stabilization..."</span>
        <span class="nb">sleep </span>60
        
        <span class="c"># 메트릭 수집 및 분석 (5분간)</span>
        <span class="nb">local </span><span class="nv">canary_metrics</span><span class="o">=</span><span class="si">$(</span>collect_metrics <span class="s2">"v</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> 300<span class="si">)</span>
        <span class="nb">local </span><span class="nv">stable_metrics</span><span class="o">=</span><span class="si">$(</span>collect_metrics <span class="s2">"v</span><span class="si">$(</span>get_current_version<span class="si">)</span><span class="s2">"</span> 300<span class="si">)</span>
        
        <span class="c"># SLO 체크</span>
        <span class="k">if</span> <span class="o">!</span> check_slo <span class="s2">"</span><span class="nv">$canary_metrics</span><span class="s2">"</span> <span class="s2">"canary"</span><span class="p">;</span> <span class="k">then
            </span>log <span class="s2">"❌ Canary version failed SLO check, rolling back..."</span>
            rollback_canary
            <span class="k">return </span>1
        <span class="k">fi</span>
        
        <span class="c"># 비교 분석</span>
        log <span class="s2">"Comparing canary vs stable metrics..."</span>
        <span class="k">if</span> <span class="o">!</span> compare_versions <span class="s2">"</span><span class="nv">$canary_metrics</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$stable_metrics</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
            </span>log <span class="s2">"❌ Canary version performance degraded, rolling back..."</span>
            rollback_canary  
            <span class="k">return </span>1
        <span class="k">fi
        
        </span>log <span class="s2">"✅ Stage </span><span class="nv">$stage</span><span class="s2">% completed successfully"</span>
        
        <span class="c"># 마지막 단계가 아니면 대기</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$stage</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"100"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span>log <span class="s2">"Waiting before next stage..."</span>
            <span class="nb">sleep </span>300  <span class="c"># 5분 대기</span>
        <span class="k">fi
    done
    
    </span>log <span class="s2">"🎉 Canary deployment completed successfully"</span>
<span class="o">}</span>

<span class="c"># 롤백 함수</span>
rollback_canary<span class="o">()</span> <span class="o">{</span>
    log <span class="s2">"Rolling back canary deployment..."</span>
    update_traffic_weight 0
    log <span class="s2">"Traffic rolled back to stable version"</span>
<span class="o">}</span>

main<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;new-version&gt;"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"=== Progressive Canary Deployment Started ==="</span>
    log <span class="s2">"App: </span><span class="nv">$APP_NAME</span><span class="s2">, New Version: </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
    
    <span class="k">if</span> <span class="o">!</span> perform_canary_deployment<span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"❌ Canary deployment failed"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"=== Canary Deployment Completed Successfully ==="</span>
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="실습-aws-ec2-기반의-블루그린-배포">실습: AWS EC2 기반의 블루그린 배포</h2>

<h3 id="️-aws-인프라-구성">🏗️ AWS 인프라 구성</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. VPC 및 서브넷 생성</span>
aws ec2 create-vpc <span class="nt">--cidr-block</span> 10.0.0.0/16 <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=vpc,Tags=[{Key=Name,Value=BlueGreen-VPC}]'</span>

<span class="nv">VPC_ID</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-vpcs <span class="nt">--filters</span> <span class="s2">"Name=tag:Name,Values=BlueGreen-VPC"</span> <span class="nt">--query</span> <span class="s1">'Vpcs[0].VpcId'</span> <span class="nt">--output</span> text<span class="si">)</span>

<span class="c"># 퍼블릭 서브넷 생성 (2개 AZ)</span>
aws ec2 create-subnet <span class="nt">--vpc-id</span> <span class="nv">$VPC_ID</span> <span class="nt">--cidr-block</span> 10.0.1.0/24 <span class="nt">--availability-zone</span> us-west-2a <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=subnet,Tags=[{Key=Name,Value=Public-Subnet-1}]'</span>

aws ec2 create-subnet <span class="nt">--vpc-id</span> <span class="nv">$VPC_ID</span> <span class="nt">--cidr-block</span> 10.0.2.0/24 <span class="nt">--availability-zone</span> us-west-2b <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=subnet,Tags=[{Key=Name,Value=Public-Subnet-2}]'</span>

<span class="c"># 프라이빗 서브넷 생성 (2개 AZ)</span>
aws ec2 create-subnet <span class="nt">--vpc-id</span> <span class="nv">$VPC_ID</span> <span class="nt">--cidr-block</span> 10.0.11.0/24 <span class="nt">--availability-zone</span> us-west-2a <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=subnet,Tags=[{Key=Name,Value=Private-Subnet-1}]'</span>

aws ec2 create-subnet <span class="nt">--vpc-id</span> <span class="nv">$VPC_ID</span> <span class="nt">--cidr-block</span> 10.0.12.0/24 <span class="nt">--availability-zone</span> us-west-2b <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=subnet,Tags=[{Key=Name,Value=Private-Subnet-2}]'</span>

<span class="c"># 인터넷 게이트웨이 생성 및 연결</span>
aws ec2 create-internet-gateway <span class="nt">--tag-specifications</span> <span class="s1">'ResourceType=internet-gateway,Tags=[{Key=Name,Value=BlueGreen-IGW}]'</span>

<span class="nv">IGW_ID</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-internet-gateways <span class="nt">--filters</span> <span class="s2">"Name=tag:Name,Values=BlueGreen-IGW"</span> <span class="nt">--query</span> <span class="s1">'InternetGateways[0].InternetGatewayId'</span> <span class="nt">--output</span> text<span class="si">)</span>

aws ec2 attach-internet-gateway <span class="nt">--vpc-id</span> <span class="nv">$VPC_ID</span> <span class="nt">--internet-gateway-id</span> <span class="nv">$IGW_ID</span>
</code></pre></div></div>

<h4 id="application-load-balancer-구성">Application Load Balancer 구성</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"LoadBalancerName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myapp-bluegreen-alb"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Scheme"</span><span class="p">:</span><span class="w"> </span><span class="s2">"internet-facing"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"IpAddressType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ipv4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Subnets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"subnet-12345678"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"subnet-87654321"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"SecurityGroups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"sg-12345678"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"Tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MyApp-BlueGreen-ALB"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Environment"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Production"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="블루그린-배포-자동화-스크립트">블루그린 배포 자동화 스크립트</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># aws-bluegreen-deploy.sh</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="c"># 설정 변수</span>
<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"myapp"</span>
<span class="nv">NEW_VERSION</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="s2">"us-west-2"</span>
<span class="nv">VPC_ID</span><span class="o">=</span><span class="s2">"vpc-12345678"</span>
<span class="nv">ALB_ARN</span><span class="o">=</span><span class="s2">"arn:aws:elasticloadbalancing:us-west-2:123456789012:loadbalancer/app/myapp-alb/1234567890123456"</span>
<span class="nv">BLUE_TG_ARN</span><span class="o">=</span><span class="s2">"arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/myapp-blue/1234567890123456"</span>
<span class="nv">GREEN_TG_ARN</span><span class="o">=</span><span class="s2">"arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/myapp-green/1234567890123456"</span>
<span class="nv">LISTENER_ARN</span><span class="o">=</span><span class="s2">"arn:aws:elasticloadbalancing:us-west-2:123456789012:listener/app/myapp-alb/1234567890123456/1234567890123456"</span>

<span class="c"># 현재 활성 환경 확인</span>
get_active_environment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">listener_rules</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-rules <span class="nt">--listener-arn</span> <span class="nv">$LISTENER_ARN</span> <span class="nt">--region</span> <span class="nv">$AWS_REGION</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">active_target_group</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$listener_rules</span> | jq <span class="nt">-r</span> <span class="s1">'.Rules[] | select(.Priority == "100") | .Actions[0].TargetGroupArn'</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$active_target_group</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$BLUE_TG_ARN</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"blue"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"green"</span>  
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># Auto Scaling Group에 새 Launch Template 적용</span>
update_asg_launch_template<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">environment</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">new_ami</span><span class="o">=</span><span class="nv">$2</span>
    
    <span class="nb">local </span><span class="nv">asg_name</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">APP_NAME</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">environment</span><span class="k">}</span><span class="s2">-asg"</span>
    <span class="nb">local </span><span class="nv">lt_name</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">APP_NAME</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">environment</span><span class="k">}</span><span class="s2">-lt"</span>
    
    <span class="c"># 새 Launch Template 버전 생성</span>
    aws ec2 create-launch-template-version <span class="se">\</span>
        <span class="nt">--launch-template-name</span> <span class="nv">$lt_name</span> <span class="se">\</span>
        <span class="nt">--source-version</span> <span class="s1">'$Latest'</span> <span class="se">\</span>
        <span class="nt">--launch-template-data</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">ImageId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$new_ami</span><span class="se">\"</span><span class="s2">}"</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span>
    
    <span class="c"># ASG에 새 Launch Template 버전 적용</span>
    <span class="nb">local </span><span class="nv">latest_version</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-launch-template-versions <span class="se">\</span>
        <span class="nt">--launch-template-name</span> <span class="nv">$lt_name</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
        <span class="nt">--query</span> <span class="s1">'LaunchTemplateVersions[0].VersionNumber'</span> <span class="se">\</span>
        <span class="nt">--output</span> text<span class="si">)</span>
    
    aws autoscaling update-auto-scaling-group <span class="se">\</span>
        <span class="nt">--auto-scaling-group-name</span> <span class="nv">$asg_name</span> <span class="se">\</span>
        <span class="nt">--launch-template</span> <span class="nv">LaunchTemplateName</span><span class="o">=</span><span class="nv">$lt_name</span>,Version<span class="o">=</span><span class="nv">$latest_version</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span>
    
    log <span class="s2">"Updated ASG </span><span class="nv">$asg_name</span><span class="s2"> with Launch Template version </span><span class="nv">$latest_version</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># 인스턴스 교체 (Rolling Replacement)</span>
perform_instance_refresh<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">environment</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">asg_name</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">APP_NAME</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">environment</span><span class="k">}</span><span class="s2">-asg"</span>
    
    log <span class="s2">"Starting instance refresh for </span><span class="nv">$asg_name</span><span class="s2">"</span>
    
    <span class="nb">local </span><span class="nv">refresh_id</span><span class="o">=</span><span class="si">$(</span>aws autoscaling start-instance-refresh <span class="se">\</span>
        <span class="nt">--auto-scaling-group-name</span> <span class="nv">$asg_name</span> <span class="se">\</span>
        <span class="nt">--preferences</span> <span class="s1">'{
            "InstanceWarmup": 300,
            "MinHealthyPercentage": 50,
            "CheckpointPercentages": [20, 50, 100],
            "CheckpointDelay": 600
        }'</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
        <span class="nt">--query</span> <span class="s1">'InstanceRefreshId'</span> <span class="se">\</span>
        <span class="nt">--output</span> text<span class="si">)</span>
    
    log <span class="s2">"Instance refresh started with ID: </span><span class="nv">$refresh_id</span><span class="s2">"</span>
    
    <span class="c"># 인스턴스 교체 완료 대기</span>
    <span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
        </span><span class="nb">local </span><span class="nv">status</span><span class="o">=</span><span class="si">$(</span>aws autoscaling describe-instance-refreshes <span class="se">\</span>
            <span class="nt">--auto-scaling-group-name</span> <span class="nv">$asg_name</span> <span class="se">\</span>
            <span class="nt">--instance-refresh-ids</span> <span class="nv">$refresh_id</span> <span class="se">\</span>
            <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
            <span class="nt">--query</span> <span class="s1">'InstanceRefreshes[0].Status'</span> <span class="se">\</span>
            <span class="nt">--output</span> text<span class="si">)</span>
        
        log <span class="s2">"Instance refresh status: </span><span class="nv">$status</span><span class="s2">"</span>
        
        <span class="k">case</span> <span class="nv">$status</span> <span class="k">in</span>
            <span class="s2">"Successful"</span><span class="p">)</span>
                log <span class="s2">"✅ Instance refresh completed successfully"</span>
                <span class="nb">break</span>
                <span class="p">;;</span>
            <span class="s2">"Failed"</span><span class="p">|</span><span class="s2">"Cancelled"</span><span class="p">)</span>
                error <span class="s2">"❌ Instance refresh failed with status: </span><span class="nv">$status</span><span class="s2">"</span>
                <span class="k">return </span>1
                <span class="p">;;</span>
            <span class="s2">"InProgress"</span><span class="p">|</span><span class="s2">"Pending"</span><span class="p">)</span>
                log <span class="s2">"Instance refresh in progress, waiting..."</span>
                <span class="nb">sleep </span>60
                <span class="p">;;</span>
        <span class="k">esac</span>
    <span class="k">done</span>
<span class="o">}</span>

<span class="c"># 헬스체크 수행</span>
health_check_environment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">environment</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span>target_group_arn
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$environment</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"blue"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">target_group_arn</span><span class="o">=</span><span class="nv">$BLUE_TG_ARN</span>
    <span class="k">else
        </span><span class="nv">target_group_arn</span><span class="o">=</span><span class="nv">$GREEN_TG_ARN</span>
    <span class="k">fi
    
    </span>log <span class="s2">"Performing health check for </span><span class="nv">$environment</span><span class="s2"> environment"</span>
    
    <span class="nb">local </span><span class="nv">max_attempts</span><span class="o">=</span>30
    <span class="nb">local </span><span class="nv">attempt</span><span class="o">=</span>1
    
    <span class="k">while</span> <span class="o">[</span> <span class="nv">$attempt</span> <span class="nt">-le</span> <span class="nv">$max_attempts</span> <span class="o">]</span><span class="p">;</span> <span class="k">do
        </span><span class="nb">local </span><span class="nv">healthy_targets</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-health <span class="se">\</span>
            <span class="nt">--target-group-arn</span> <span class="nv">$target_group_arn</span> <span class="se">\</span>
            <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
            <span class="nt">--query</span> <span class="s1">'TargetHealthDescriptions[?TargetHealth.State==`healthy`] | length(@)'</span><span class="si">)</span>
        
        <span class="nb">local </span><span class="nv">total_targets</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-health <span class="se">\</span>
            <span class="nt">--target-group-arn</span> <span class="nv">$target_group_arn</span> <span class="se">\</span>
            <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
            <span class="nt">--query</span> <span class="s1">'TargetHealthDescriptions | length(@)'</span><span class="si">)</span>
        
        log <span class="s2">"Health check attempt </span><span class="nv">$attempt</span><span class="s2">: </span><span class="nv">$healthy_targets</span><span class="s2">/</span><span class="nv">$total_targets</span><span class="s2"> targets healthy"</span>
        
        <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$healthy_targets</span><span class="s2">"</span> <span class="nt">-gt</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$healthy_targets</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s2">"</span><span class="nv">$total_targets</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span>log <span class="s2">"✅ All targets are healthy in </span><span class="nv">$environment</span><span class="s2"> environment"</span>
            <span class="k">return </span>0
        <span class="k">fi
        
        </span><span class="nb">sleep </span>30
        <span class="o">((</span>attempt++<span class="o">))</span>
    <span class="k">done
    
    </span>error <span class="s2">"❌ Health check failed for </span><span class="nv">$environment</span><span class="s2"> environment after </span><span class="nv">$max_attempts</span><span class="s2"> attempts"</span>
    <span class="k">return </span>1
<span class="o">}</span>

<span class="c"># 트래픽 전환</span>
switch_traffic<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">target_environment</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span>target_group_arn
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$target_environment</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"blue"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">target_group_arn</span><span class="o">=</span><span class="nv">$BLUE_TG_ARN</span>
    <span class="k">else
        </span><span class="nv">target_group_arn</span><span class="o">=</span><span class="nv">$GREEN_TG_ARN</span>
    <span class="k">fi
    
    </span>log <span class="s2">"Switching traffic to </span><span class="nv">$target_environment</span><span class="s2"> environment"</span>
    
    aws elbv2 modify-rule <span class="se">\</span>
        <span class="nt">--rule-arn</span> <span class="si">$(</span>aws elbv2 describe-rules <span class="nt">--listener-arn</span> <span class="nv">$LISTENER_ARN</span> <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="nt">--query</span> <span class="s1">'Rules[?Priority==`100`].RuleArn'</span> <span class="nt">--output</span> text<span class="si">)</span> <span class="se">\</span>
        <span class="nt">--actions</span> <span class="nv">Type</span><span class="o">=</span>forward,TargetGroupArn<span class="o">=</span><span class="nv">$target_group_arn</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span>
    
    log <span class="s2">"✅ Traffic switched to </span><span class="nv">$target_environment</span><span class="s2"> environment"</span>
<span class="o">}</span>

<span class="c"># 배포 검증</span>
validate_deployment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">environment</span><span class="o">=</span><span class="nv">$1</span>
    
    log <span class="s2">"Validating deployment in </span><span class="nv">$environment</span><span class="s2"> environment"</span>
    
    <span class="c"># ALB DNS 이름 가져오기</span>
    <span class="nb">local </span><span class="nv">alb_dns</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="se">\</span>
        <span class="nt">--load-balancer-arns</span> <span class="nv">$ALB_ARN</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
        <span class="nt">--query</span> <span class="s1">'LoadBalancers[0].DNSName'</span> <span class="se">\</span>
        <span class="nt">--output</span> text<span class="si">)</span>
    
    <span class="c"># 애플리케이션 버전 확인</span>
    <span class="nb">local </span><span class="nv">app_version</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nt">-f</span> http://<span class="nv">$alb_dns</span>/version 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"unknown"</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$app_version</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"✅ Application version validated: </span><span class="nv">$app_version</span><span class="s2">"</span>
    <span class="k">else
        </span>error <span class="s2">"❌ Version mismatch. Expected: </span><span class="nv">$NEW_VERSION</span><span class="s2">, Got: </span><span class="nv">$app_version</span><span class="s2">"</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
    
    <span class="c"># 기본 기능 테스트</span>
    <span class="nb">local </span><span class="nv">health_status</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}"</span> http://<span class="nv">$alb_dns</span>/health<span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$health_status</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"200"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>log <span class="s2">"✅ Application health check passed"</span>
    <span class="k">else
        </span>error <span class="s2">"❌ Application health check failed. Status code: </span><span class="nv">$health_status</span><span class="s2">"</span>
        <span class="k">return </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"✅ Deployment validation completed successfully"</span>
<span class="o">}</span>

<span class="c"># 롤백 수행</span>
rollback_deployment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">current_environment</span><span class="o">=</span><span class="si">$(</span>get_active_environment<span class="si">)</span>
    <span class="nb">local </span>rollback_environment
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$current_environment</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"blue"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">rollback_environment</span><span class="o">=</span><span class="s2">"green"</span>
    <span class="k">else
        </span><span class="nv">rollback_environment</span><span class="o">=</span><span class="s2">"blue"</span>
    <span class="k">fi
    
    </span>log <span class="s2">"Rolling back from </span><span class="nv">$current_environment</span><span class="s2"> to </span><span class="nv">$rollback_environment</span><span class="s2">"</span>
    
    switch_traffic <span class="nv">$rollback_environment</span>
    
    log <span class="s2">"✅ Rollback completed"</span>
<span class="o">}</span>

<span class="c"># 메인 배포 로직</span>
main<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;new-version&gt;"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"=== AWS EC2 Blue-Green Deployment Started ==="</span>
    log <span class="s2">"Application: </span><span class="nv">$APP_NAME</span><span class="s2">"</span>
    log <span class="s2">"New Version: </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
    log <span class="s2">"Region: </span><span class="nv">$AWS_REGION</span><span class="s2">"</span>
    
    <span class="c"># 1. 현재 활성 환경 확인</span>
    <span class="nb">local </span><span class="nv">active_env</span><span class="o">=</span><span class="si">$(</span>get_active_environment<span class="si">)</span>
    <span class="nb">local </span>inactive_env
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$active_env</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"blue"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">inactive_env</span><span class="o">=</span><span class="s2">"green"</span>
    <span class="k">else
        </span><span class="nv">inactive_env</span><span class="o">=</span><span class="s2">"blue"</span>
    <span class="k">fi
    
    </span>log <span class="s2">"Current active environment: </span><span class="nv">$active_env</span><span class="s2">"</span>
    log <span class="s2">"Deploying to inactive environment: </span><span class="nv">$inactive_env</span><span class="s2">"</span>
    
    <span class="c"># 2. 새 AMI ID 가져오기 (이미 빌드된 AMI 사용)</span>
    <span class="nb">local </span><span class="nv">new_ami</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-images <span class="se">\</span>
        <span class="nt">--filters</span> <span class="s2">"Name=tag:Version,Values=</span><span class="nv">$NEW_VERSION</span><span class="s2">"</span> <span class="s2">"Name=tag:Application,Values=</span><span class="nv">$APP_NAME</span><span class="s2">"</span> <span class="se">\</span>
        <span class="nt">--region</span> <span class="nv">$AWS_REGION</span> <span class="se">\</span>
        <span class="nt">--query</span> <span class="s1">'Images[0].ImageId'</span> <span class="se">\</span>
        <span class="nt">--output</span> text<span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$new_ami</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"None"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$new_ami</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"❌ AMI for version </span><span class="nv">$NEW_VERSION</span><span class="s2"> not found"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"Using AMI: </span><span class="nv">$new_ami</span><span class="s2"> for version </span><span class="nv">$NEW_VERSION</span><span class="s2">"</span>
    
    <span class="c"># 3. 비활성 환경에 새 버전 배포</span>
    <span class="k">if</span> <span class="o">!</span> update_asg_launch_template <span class="nv">$inactive_env</span> <span class="nv">$new_ami</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"❌ Failed to update launch template"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
    
    if</span> <span class="o">!</span> perform_instance_refresh <span class="nv">$inactive_env</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"❌ Failed to refresh instances"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># 4. 비활성 환경 헬스체크</span>
    <span class="k">if</span> <span class="o">!</span> health_check_environment <span class="nv">$inactive_env</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"❌ Health check failed for </span><span class="nv">$inactive_env</span><span class="s2"> environment"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># 5. 트래픽 전환</span>
    <span class="k">if</span> <span class="o">!</span> switch_traffic <span class="nv">$inactive_env</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"❌ Failed to switch traffic"</span>
        rollback_deployment
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c"># 6. 배포 검증</span>
    <span class="nb">sleep </span>60  <span class="c"># 트래픽 안정화 대기</span>
    
    <span class="k">if</span> <span class="o">!</span> validate_deployment <span class="nv">$inactive_env</span><span class="p">;</span> <span class="k">then
        </span>error <span class="s2">"❌ Deployment validation failed"</span>
        rollback_deployment
        <span class="nb">exit </span>1
    <span class="k">fi
    
    </span>log <span class="s2">"🎉 Blue-Green deployment completed successfully!"</span>
    log <span class="s2">"New active environment: </span><span class="nv">$inactive_env</span><span class="s2">"</span>
    log <span class="s2">"Previous environment (</span><span class="nv">$active_env</span><span class="s2">) is now inactive and ready for next deployment"</span>
<span class="o">}</span>

<span class="c"># 유틸리티 함수</span>
log<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"[</span><span class="si">$(</span><span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="si">)</span><span class="s2">] </span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

error<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"[</span><span class="si">$(</span><span class="nb">date</span> +<span class="s1">'%Y-%m-%d %H:%M:%S'</span><span class="si">)</span><span class="s2">] ERROR: </span><span class="nv">$1</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>

<span class="c"># 스크립트 실행</span>
main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="정리-및-모범-사례">정리 및 모범 사례</h2>

<h3 id="-배포-전략-선택-가이드">📊 배포 전략 선택 가이드</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 전략 선택 매트릭스</span>
상황                     | 권장 전략        | 이유
<span class="o">====================</span>|<span class="o">===============</span>|<span class="o">==============================</span>
개발/테스트 환경         | Recreate      | 단순함, 리소스 절약
스테이지 환경           | Rolling       | 프로덕션과 유사한 환경
프로덕션 <span class="o">(</span>위험 높음<span class="o">)</span>     | Blue-Green    | 즉시 롤백, 완전한 검증
프로덕션 <span class="o">(</span>위험 보통<span class="o">)</span>     | Canary        | 점진적 검증, 리스크 분산
프로덕션 <span class="o">(</span>위험 낮음<span class="o">)</span>     | Rolling       | 효율적, 리소스 최적화
레거시 시스템           | Blue-Green    | 안전성 우선
마이크로서비스          | Canary        | 서비스별 독립 배포
</code></pre></div></div>

<h3 id="-모범-사례">🔧 모범 사례</h3>

<h4 id="1-배포-준비">1. 배포 준비</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 전 체크리스트</span>
✅ 백업 완료
✅ 롤백 계획 수립
✅ 모니터링 준비
✅ 팀 커뮤니케이션
✅ 헬스체크 엔드포인트 구현
✅ 설정 검증
</code></pre></div></div>

<h4 id="2-모니터링-및-알람">2. 모니터링 및 알람</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 핵심 메트릭</span>
- 에러율 <span class="o">(</span>&lt; 1%<span class="o">)</span>
- 응답 시간 <span class="o">(</span>&lt; 500ms<span class="o">)</span>
- 처리량 <span class="o">(</span>baseline 대비<span class="o">)</span>
- 리소스 사용률 <span class="o">(</span>&lt; 80%<span class="o">)</span>
- 가용성 <span class="o">(&gt;</span> 99.9%<span class="o">)</span>
</code></pre></div></div>

<h4 id="3-자동화-원칙">3. 자동화 원칙</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모든 것을 자동화</span>
1. 빌드 프로세스
2. 테스트 실행
3. 배포 프로세스
4. 헬스체크
5. 롤백 절차
6. 알림 및 로깅
</code></pre></div></div>

<p>현대적인 배포 전략을 마스터하셨나요? 안정적이고 효율적인 배포로 서비스 품질을 한 단계 높여보세요! 🚀</p>

  </div>

  <footer class="post-footer">
    <div class="post-navigation"><div class="nav-previous">
        <a href="/infra-blog/blog/2024/11/03/networking-guide-part3.html" rel="prev">
          <i class="icon-left-arrow"></i>
          <span class="nav-title">네트워킹 완전 가이드 3편 - 라우팅과 스위칭 심화 | Complete Network...</span>
        </a>
      </div><div class="nav-next">
        <a href="/infra-blog/blog/2024/12/08/linux-security-guide-part2.html" rel="next">
          <span class="nav-title">리눅스 보안 완전 가이드 2편 - SSH 고급 보안과 방화벽 | Linux Secur...</span>
          <i class="icon-right-arrow"></i>
        </a>
      </div></div>
  </footer>
  </article></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://github.com/leeyonghe" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/lee-yong-hee-18912454/" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><!----></ul><p class="about-footer condensed">&copy;
        2025</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </footer>
  </main>
  
  <script type="text/javascript" src="/infra-blog/assets/js/darkmode.js"></script>
  
  <script src="/infra-blog/assets/js/simple-jekyll-search.min.js"></script>
  <script src="/infra-blog/assets/js/search.js"></script>
  
</body>

</html>
